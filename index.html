<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë¶€ì²œFC1995 ë°ì´í„° í¬í„¸</title>
    <style>
        :root { --bfc-red: #ed1c24; --bfc-black: #1a1a1a; --bg-gray: #f4f4f4; --win-gold: #ffd700; }
        body { font-family: 'Pretendard', sans-serif; margin: 0; background-color: var(--bg-gray); color: #333; display: flex; flex-direction: column; min-height: 100vh; -webkit-text-size-adjust: none; }

        header { background: linear-gradient(135deg, var(--bfc-black) 60%, var(--bfc-red)); color: white; padding: 40px 20px 60px; text-align: center; border-bottom: 6px solid var(--bfc-red); position: relative; }
        .home-link { text-decoration: none; color: white; display: inline-flex; align-items: center; gap: 10px; cursor: pointer; }
        header h1 { margin: 0; font-size: 1.8rem; font-weight: 900; }

        .stats-dashboard { background: rgba(255, 255, 255, 0.1); margin: 20px auto 0; padding: 12px 25px; border-radius: 50px; display: inline-block; backdrop-filter: blur(5px); border: 1px solid rgba(255, 255, 255, 0.2); font-size: 0.9rem; }
        
        .streak-container { display: flex; justify-content: center; gap: 15px; margin-top: 15px; flex-wrap: wrap; }
        .streak-badge { background: rgba(0, 0, 0, 0.3); padding: 8px 15px; border-radius: 10px; font-size: 0.8rem; border: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; transition: 0.2s; }
        .streak-badge:hover { background: rgba(255, 255, 255, 0.1); border-color: var(--win-gold); }
        .streak-badge b { color: var(--win-gold); }
        .current-streak { border: 1px solid var(--win-gold); background: rgba(255, 215, 0, 0.15); animation: pulse 2s infinite; cursor: default; }
        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; } 100% { opacity: 0.8; } }

        .mode-switch { display: flex; justify-content: center; gap: 10px; margin-top: -25px; position: relative; z-index: 100; }
        .mode-btn { background: white; border: 2px solid var(--bfc-red); color: var(--bfc-red); padding: 12px 30px; border-radius: 50px; font-weight: 800; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .mode-btn.active { background: var(--bfc-red); color: white; }

        .history-btn { background: #ffd700; border: 2px solid #b8860b; color: #000; margin-left: 10px; }
        .history-btn.active { background: #b8860b; color: #fff; }
        .away-btn { background: var(--bfc-black); border: 2px solid var(--bfc-black); color: white; height: 45px; border-radius: 10px; font-weight: 800; cursor: pointer; transition: 0.3s; width: 100%; }
        
        .container { max-width: 1300px; margin: 30px auto 50px; padding: 0 15px; flex: 1; position: relative; z-index: 10; }
        .ranking-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 40px; }
        .ranking-box { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-top: 4px solid var(--bfc-black); position: relative; }
        .ranking-box h3 { margin: 0 0 15px 0; font-size: 0.95rem; color: var(--bfc-red); }
        
        .filter-container { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; align-items: end; }
        .filter-item { display: flex; flex-direction: column; gap: 8px; position: relative; }
        select, input { padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 0.95rem; outline: none; width: 100%; box-sizing: border-box; height: 45px; }

        .view-header { margin-top: 20px; background: white; padding: 20px; border-radius: 15px; border-left: 6px solid var(--bfc-red); box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: none; flex-direction: column; gap: 10px; }
        .view-summary { font-size: 0.95rem; color: #555; border-top: 1px dashed #eee; padding-top: 10px; }
        .results-box { background: white; border-radius: 15px; margin-top: 15px; overflow-x: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 1100px; }
        th { background: #f8f9fa; padding: 15px; font-size: 0.75rem; color: #555; text-align: center; cursor: pointer; }
        td { padding: 12px; text-align: center; border-bottom: 1px solid #f0f0f0; font-size: 0.85rem; }

        .highlight-red { color: var(--bfc-red); font-weight: bold; }
        footer { background-color: var(--bfc-black); color: #999; text-align: center; padding: 40px 20px; margin-top: auto; line-height: 1.8; }

        @media (max-width: 768px) {
            header h1 { font-size: 1.4rem; }
            .mode-btn { padding: 10px 5px; font-size: 0.75rem; }
            .filter-container { grid-template-columns: 1fr !important; }
            .streak-container { gap: 8px; }
            .streak-badge { font-size: 0.7rem; padding: 6px 10px; }
        }
    </style>
</head>
<body>

<div id="modal-overlay" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <span style="position:absolute; top:15px; right:20px; font-size:1.5rem; cursor:pointer; color:#999;" onclick="closeModal()">&times;</span>
        <div id="modal-data"></div>
    </div>
</div>

<header>
    <a href="javascript:void(0)" onclick="resetToAll()" class="home-link"><h1>ë¶€ì²œFC1995 ë°ì´í„° í¬í„¸</h1></a>
    <div id="today-date" style="margin-top: 10px; font-size: 1rem; opacity: 0.8;"></div>
    
    <div class="stats-dashboard">
        <span id="stat-total">0ê²½ê¸°</span> | <span id="stat-w">0ìŠ¹</span> <span id="stat-d">0ë¬´</span> <span id="stat-l">0íŒ¨</span> | 
        <span id="stat-gf">0ë“</span> <span id="stat-ga">0ì‹¤</span> | <span id="stat-rate">0%</span>
    </div>

    <div class="streak-container">
        <div class="streak-badge" onclick="showStreakDetail('win')">ì—­ëŒ€ ìµœë‹¤ ì—°ìŠ¹: <b id="best-win-streak">0</b>ê²½ê¸° <small style="opacity:0.6;">ë³´ëŸ¬ê°€ê¸°â†’</small></div>
        <div class="streak-badge" onclick="showStreakDetail('unbeaten')">ì—­ëŒ€ ìµœë‹¤ ë¬´íŒ¨: <b id="best-unbeaten-streak">0</b>ê²½ê¸° <small style="opacity:0.6;">ë³´ëŸ¬ê°€ê¸°â†’</small></div>
        <div id="current-streak-box" class="streak-badge current-streak" style="display:none;">í˜„ì¬ <span id="current-streak-text"></span> ì§„í–‰ ì¤‘! ğŸ”¥</div>
    </div>
</header>

<div class="mode-switch">
    <button id="mode-t" class="mode-btn active" onclick="switchMode('team')">ğŸŸï¸ íŒ€ ê²½ê¸° ê¸°ë¡</button>
    <button id="mode-p" class="mode-btn" onclick="switchMode('player')">ğŸƒâ€â™‚ï¸ ì„ ìˆ˜ ê°œì¸ ê¸°ë¡</button>
    <button id="mode-h" class="mode-btn history-btn" onclick="showHistorySection()">ğŸ“œ TODAY'S HISTORY</button>
</div>

<div class="container">
    <div id="team-section">
        <div id="team-filter-1" class="filter-container">
            <div class="filter-item"><label>ì‹œì¦Œë³„</label><select id="select-year" onchange="updateView()"><option value="">ì „ì²´ ì‹œì¦Œ</option></select></div>
            <div class="filter-item"><label>í™ˆ/ì›ì •</label><select id="select-location" onchange="updateView()"><option value="">ì „ì²´</option><option value="home">í™ˆ ê²½ê¸°</option><option value="away">ì›ì • ê²½ê¸°</option></select></div>
            <div class="filter-item"><label>ê°ë…ë³„</label><select id="select-manager" onchange="updateView()"><option value="">ëª¨ë“  ê°ë…</option></select></div>
            <div class="filter-item">
                <label>ëŒ€íšŒë³„ ì¡°íšŒ</label>
                <select id="select-league" onchange="updateView()">
                    <option value="">ëª¨ë“  ëŒ€íšŒ</option>
                    <option value="Kë¦¬ê·¸1">Kë¦¬ê·¸1</option>
                    <option value="Kë¦¬ê·¸2">Kë¦¬ê·¸2</option>
                    <option value="K3ë¦¬ê·¸">K3ë¦¬ê·¸</option>
                    <option value="í”Œë ˆì´ì˜¤í”„">í”Œë ˆì´ì˜¤í”„</option>
                    <option value="ì½”ë¦¬ì•„ì»µ">ì½”ë¦¬ì•„ì»µ</option>
                </select>
            </div>
        </div>
        <div id="team-filter-2" class="filter-container" style="margin-top: 15px; grid-template-columns: repeat(4, 1fr);">
            <div class="filter-item"><label>ìƒëŒ€íŒ€ ê²€ìƒ‰</label><input type="text" id="search-opponent" placeholder="íŒ€ëª… ì…ë ¥" onkeyup="showSuggestions(this, 'opponentName')" autocomplete="off"><ul class="search-results"></ul></div>
            <div class="filter-item"><label>ìƒëŒ€ê°ë… ê²€ìƒ‰</label><input type="text" id="search-opp-manager" placeholder="ê°ë…ëª… ì…ë ¥" onkeyup="showSuggestions(this, 'opp_manager')" autocomplete="off"><ul class="search-results"></ul></div>
            <div class="filter-item"><label>ì£¼ì‹¬ ê²€ìƒ‰</label><input type="text" id="search-referee" placeholder="ì£¼ì‹¬ ì„±í•¨ ì…ë ¥" onkeyup="showSuggestions(this, 'referee')" autocomplete="off"><ul class="search-results"></ul></div>
            <div class="filter-item"><button id="btn-away-fan" class="away-btn" onclick="showAwayFanSection()">ğŸšŒ í•¨ê»˜í–ˆë˜ ì›ì •íŒ¬ ì¡°íšŒ</button></div>
        </div>
        <div id="team-notice" class="data-notice">
            <b>ğŸ’¡ ë°ì´í„° ì•ˆë‚´</b><br>â€¢ íŒ€ ê²½ê¸°ê¸°ë¡ì€ 2007ë…„ ì°½ë‹¨ ì´í›„ ë¶€ì²œFC1995ì˜ ëª¨ë“  ê³µì‹ ëŒ€íšŒë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì œê³µí•©ë‹ˆë‹¤.
        </div>
    </div>

    <div id="player-section" style="display: none;">
        </div>

    <div id="dynamic-header" class="view-header">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div id="dynamic-title" style="font-weight:bold; font-size:1.1rem; word-break:keep-all;"></div>
            <button class="mode-btn" style="padding: 5px 15px; font-size: 0.8rem; flex:none;" onclick="resetToAll()">ì´ì „ ê²°ê³¼ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
        <div id="dynamic-summary" class="view-summary"></div>
    </div>
    <div class="results-box"><table><thead id="table-head"></thead><tbody id="table-body"></tbody></table></div>
</div>

<footer>
    <p>ë¶€ì²œFC1995 ë°ì´í„° í¬í„¸ (ê°œì¸ ìš´ì˜) <br> Â© 2026 BFC1995 ë°ì´í„° í¬í„¸. All Rights Reserved.</p>
</footer>

<script>
    const TEAM_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQTLnO6CTQkcgJTDHr0MNJAA5xUCCWSqWSq-fgvJkEIGRrOBH1D9EXNXJLxIAriWiQ1oMrSKxTq6Y8m/pub?gid=0&single=true&output=csv";
    const PLAYER_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQTLnO6CTQkcgJTDHr0MNJAA5xUCCWSqWSq-fgvJkEIGRrOBH1D9EXNXJLxIAriWiQ1oMrSKxTq6Y8m/pub?gid=1150204300&single=true&output=csv";
    
    let rawData = [], playerSeasonData = [], currentMode = 'team';
    let sortState = { column: 'date', direction: 'desc' };
    let currentFilter = { opponent: null, stadium: null, type: null, streakMatches: [] }; 

    async function loadData() {
        try {
            const [tRes, pRes] = await Promise.all([fetch(TEAM_URL + "&cb=" + Date.now()), fetch(PLAYER_URL + "&cb=" + Date.now())]);
            rawData = parseCSV(await tRes.text()); playerSeasonData = parseCSV(await pRes.text());
            const now = new Date(); document.getElementById('today-date').innerText = `${now.getFullYear()}ë…„ ${now.getMonth() + 1}ì›” ${now.getDate()}ì¼ ê¸°ì¤€`;
            fixAllTimeStats(); calculateStreaks(); calculateTotalRankings(); initFilters(); updateView();
        } catch (e) { console.error("Load Error", e); }
    }

    function parseCSV(text) {
        const rows = text.split(/\r?\n/).filter(l => l.trim() !== "");
        if (rows.length < 1) return [];
        const heads = rows[0].split(',').map(h => h.trim().toLowerCase().replace(/[^\w]/gi, ''));
        return rows.slice(1).map(line => {
            const vals = []; let start = 0, inQ = false;
            for (let i = 0; i < line.length; i++) { if (line[i] === '"') inQ = !inQ; if (line[i] === ',' && !inQ) { vals.push(line.substring(start, i)); start = i + 1; } }
            vals.push(line.substring(start)); let o = {};
            heads.forEach((h, i) => o[h] = (vals[i] || "").trim().replace(/^"|"$/g, "").trim()); return o;
        });
    }

    // [ì‹ ê·œ] ì—°ì† ê¸°ë¡ ì‚°ì • ë° ìƒì„¸ ê²½ê¸° ì¶”ì¶œ ë¡œì§
    let bestWinStreakMatches = [];
    let bestUnbeatenStreakMatches = [];

    function calculateStreaks() {
        if (!rawData.length) return;
        const sortedData = [...rawData].sort((a, b) => new Date(a.date) - new Date(b.date));
        let bestWin = 0, bestUnbeaten = 0;
        let currentWinPool = [], currentUnbeatenPool = [];
        let ongoingWinCount = 0, ongoingUnbeatenCount = 0;

        sortedData.forEach((m, index) => {
            const isH = (m.hometeam || "").includes("ë¶€ì²œ");
            const myS = isH ? parseInt(m.homescored)||0 : parseInt(m.awayscored)||0;
            const opS = isH ? parseInt(m.awayscored)||0 : parseInt(m.homescored)||0;

            // 1. ì—°ìŠ¹ ê³„ì‚°
            if (myS > opS) {
                currentWinPool.push(m);
                if (currentWinPool.length >= bestWin) {
                    bestWin = currentWinPool.length;
                    bestWinStreakMatches = [...currentWinPool];
                }
            } else { currentWinPool = []; }

            // 2. ë¬´íŒ¨ ê³„ì‚°
            if (myS >= opS) {
                currentUnbeatenPool.push(m);
                if (currentUnbeatenPool.length >= bestUnbeaten) {
                    bestUnbeaten = currentUnbeatenPool.length;
                    bestUnbeatenStreakMatches = [...currentUnbeatenPool];
                }
            } else { currentUnbeatenPool = []; }

            if (index === sortedData.length - 1) {
                ongoingWinCount = currentWinPool.length;
                ongoingUnbeatenCount = currentUnbeatenPool.length;
            }
        });

        document.getElementById('best-win-streak').innerText = bestWin;
        document.getElementById('best-unbeaten-streak').innerText = bestUnbeaten;

        const currentBox = document.getElementById('current-streak-box');
        const currentText = document.getElementById('current-streak-text');
        if (ongoingWinCount > 1) {
            currentBox.style.display = 'inline-block';
            currentText.innerText = `${ongoingWinCount}ì—°ìŠ¹`;
        } else if (ongoingUnbeatenCount > 1) {
            currentBox.style.display = 'inline-block';
            currentText.innerText = `${ongoingUnbeatenCount}ê²½ê¸° ì—°ì† ë¬´íŒ¨`;
        } else { currentBox.style.display = 'none'; }
    }

    // [ì‹ ê·œ] ê¸°ë¡ ë³´ëŸ¬ê°€ê¸° í´ë¦­ ì‹œ ì‹¤í–‰ í•¨ìˆ˜
    function showStreakDetail(type) {
        resetToAll();
        currentFilter.type = 'streak_detail';
        currentFilter.streakMatches = (type === 'win') ? bestWinStreakMatches : bestUnbeatenStreakMatches;
        
        // ë ˆì´ì•„ì›ƒ ê°•ì œ ë™ê¸°í™” (íŒ€ í•„í„° ìˆ¨ê¹€)
        document.getElementById('team-filter-1').style.display = 'none';
        document.getElementById('team-filter-2').style.display = 'none';
        document.getElementById('team-notice').style.display = 'none';
        document.getElementById('player-section').style.display = 'none';
        
        sortState = { column: 'date', direction: 'asc' }; // ê¸°ë¡ íë¦„ì„ ë³´ê¸° ìœ„í•´ ê³¼ê±°ìˆœ ì •ë ¬
        updateView();
    }

    function updateView() { if (currentMode === 'team' || currentFilter.type) renderTeamTable(); else { if (isTotalRankMode) renderAllRankingsTable(); else renderPlayerTable(); } }

    function renderTeamTable() {
        const year = document.getElementById('select-year').value, loc = document.getElementById('select-location').value, mgr = document.getElementById('select-manager').value, selLg = document.getElementById('select-league').value;
        const sOpp = (document.getElementById('search-opponent')?.value || "").trim(), sOppMgr = (document.getElementById('search-opp-manager')?.value || "").trim(), sRef = (document.getElementById('search-referee')?.value || "").trim();
        const header = document.getElementById('dynamic-header'), titleEl = document.getElementById('dynamic-title'), summary = document.getElementById('dynamic-summary');
        
        let filtered = [];

        if (currentFilter.type === 'opening_match') {
            header.style.display = "flex"; titleEl.innerText = `ğŸ” ë¶€ì²œFC1995 ì—­ëŒ€ ë¦¬ê·¸ ê°œë§‰ì „ ê²½ê¸°ê²°ê³¼`;
            const yearGroups = {};
            rawData.forEach(m => { if (m.league.includes("ë¦¬ê·¸")) { const y = m.date.substring(0, 4); if (!yearGroups[y] || new Date(m.date) < new Date(yearGroups[y].date)) { yearGroups[y] = m; } } });
            filtered = Object.values(yearGroups).filter(m => (!loc || (loc === 'home' ? (m.hometeam||"").includes("ë¶€ì²œ") : !(m.hometeam||"").includes("ë¶€ì²œ"))) && (!mgr || (m.bfcmanager || m.bfc_manager) === mgr) && (!year || m.date.startsWith(year)) && (!selLg || getUnifiedLeagueName(m.league) === selLg));
        } 
        else if (currentFilter.type === 'away_fan') {
            header.style.display = "flex"; titleEl.innerText = `ğŸ” ë¶€ì²œFC1995 ì›ì •ê²½ê¸°ì— í•¨ê»˜í•œ ì›ì •ê´€ì¤‘ ê¸°ë¡`;
            filtered = rawData.filter(m => !(m.hometeam || "").includes("ë¶€ì²œ") && parseInt(m.date.substring(0,4)) >= 2023);
        }
        else if (currentFilter.type === 'streak_detail') {
            header.style.display = "flex"; 
            const isWin = currentFilter.streakMatches === bestWinStreakMatches;
            titleEl.innerText = isWin ? `ğŸ† ë¶€ì²œFC1995 ì—­ëŒ€ ìµœë‹¤ ${bestWinStreakMatches.length}ì—°ìŠ¹ ê¸°ë¡` : `ğŸ”¥ ë¶€ì²œFC1995 ì—­ëŒ€ ìµœë‹¤ ${bestUnbeatenStreakMatches.length}ê²½ê¸° ë¬´íŒ¨ ê¸°ë¡`;
            filtered = [...currentFilter.streakMatches];
        }
        else {
            const hasFilter = currentFilter.opponent || currentFilter.stadium || year || mgr || selLg || sOpp || sOppMgr || sRef;
            if (hasFilter) {
                header.style.display = "flex";
                const tOpp = getUnifiedTeamName(sOpp || currentFilter.opponent), bfcMgr = mgr, oppMgr = sOppMgr, ref = sRef;
                let titleStr = "";
                if (ref) titleStr = `${ref} ì£¼ì‹¬ì´ ì§„í–‰í•œ ê²½ê¸° ê²°ê³¼`;
                else if (bfcMgr && oppMgr) titleStr = `${oppMgr} ê°ë…ê³¼ ${bfcMgr} ê°ë…ì˜ ë§ëŒ€ê²° ê²°ê³¼`;
                else if (oppMgr) titleStr = `${oppMgr} ê°ë…ê³¼ì˜ ê²½ê¸° ê²°ê³¼`;
                else if (tOpp) titleStr = `${tOpp}${getWithParticle(tOpp, true)} ê²½ê¸° ê²°ê³¼`;
                else if (bfcMgr) titleStr = `${bfcMgr} ê°ë…ì˜ ê²½ê¸° ê²°ê³¼`;
                else titleStr = "ì¡°íšŒ ê²°ê³¼";
                titleEl.innerText = `ğŸ” ${titleStr}${year ? ` (${year}ì‹œì¦Œ)` : ""}`;
            } else header.style.display = "none";
            filtered = rawData.filter(m => {
                const isH = (m.hometeam || "").includes("ë¶€ì²œ");
                const oppUnified = getUnifiedTeamName(isH ? m.awayteam : m.hometeam);
                if (currentFilter.opponent && oppUnified !== getUnifiedTeamName(currentFilter.opponent)) return false;
                if (sOpp && !oppUnified.includes(getUnifiedTeamName(sOpp))) return false;
                if (sOppMgr && !(m.opp_manager || "").includes(sOppMgr)) return false;
                if (sRef && !(m.referee || "").includes(sRef)) return false;
                if (year && !m.date.startsWith(year)) return false;
                if (mgr && (m.bfcmanager || m.bfc_manager) !== mgr) return false;
                if (loc && (loc === 'home' ? !isH : isH)) return false;
                if (selLg && getUnifiedLeagueName(m.league) !== selLg) return false; return true;
            });
        }

        if(header.style.display !== "none") {
            if (currentFilter.type === 'away_fan') summary.innerHTML = `â€¢ ì›ì •ê´€ì¤‘ìˆ˜ ê¸°ë¡ì€ 2023ë…„ ì´í›„ Kë¦¬ê·¸ ê²½ê¸°ì—ì„œë§Œ ë°œí‘œë˜ê³  ìˆìŠµë‹ˆë‹¤.`;
            else if (currentFilter.type === 'streak_detail') summary.innerHTML = `ë¶€ì²œFC1995 ì—­ì‚¬ìƒ ê°€ì¥ ì°¬ë€í–ˆë˜ ${filtered.length}ê²½ê¸°ì˜ ê¸°ë¡ì…ë‹ˆë‹¤.`;
            else {
                let tw=0, td=0, tl=0; filtered.forEach(m => { const isH = (m.hometeam || "").includes("ë¶€ì²œ"), hS = parseInt(m.homescored)||0, aS = parseInt(m.awayscored)||0, myS = isH ? hS : aS, opS = isH ? aS : hS; if (myS > opS) tw++; else if (myS < opS) tl++; else td++; });
                summary.innerHTML = `ì¡°íšŒ ê²°ê³¼: <span>${filtered.length}ê²½ê¸° ${tw}ìŠ¹ ${td}ë¬´ ${tl}íŒ¨</span>`;
            }
            summary.style.display = 'block';
        }

        let dData = [...filtered].sort((a,b) => {
            let vA = a[sortState.column], vB = b[sortState.column];
            if(sortState.column === 'attendance' || sortState.column === 'awayfan') { 
                vA = parseInt(String(vA).replace(/,/g,''))||0; vB = parseInt(String(vB).replace(/,/g,''))||0; 
                if (sortState.direction === 'asc') return (vA || Infinity) - (vB || Infinity); 
            }
            return sortState.direction === 'asc' ? (vA > vB ? 1 : -1) : (vA < vB ? 1 : -1);
        });
        
        const isAwayMode = currentFilter.type === 'away_fan';
        document.getElementById('table-head').innerHTML = `<tr><th onclick="toggleSort('date')">ë‚ ì§œ â†•</th><th>ëŒ€íšŒ</th><th>ìƒëŒ€</th><th>ìŠ¤ì½”ì–´</th><th>ê²°ê³¼</th><th onclick="toggleSort('${isAwayMode ? 'awayfan' : 'attendance'}')">${isAwayMode ? 'ì›ì •íŒ¬' : 'ê´€ì¤‘'} â†•</th><th>ê°ë…</th></tr>`;
        document.getElementById('table-body').innerHTML = dData.map(m => { 
            const isH = (m.hometeam || "").includes("ë¶€ì²œ"), hS = parseInt(m.homescored)||0, aS = parseInt(m.awayscored)||0, myS = isH ? hS : aS, opS = isH ? aS : hS, res = myS > opS ? "ìŠ¹" : (myS < opS ? "íŒ¨" : "ë¬´"); 
            const val = isAwayMode ? (parseInt(m.awayfan)||0) : (parseInt(String(m.attendance).replace(/,/g,''))||0);
            return `<tr><td>${m.date}</td><td>${m.league}</td><td>${isH?m.awayteam:m.hometeam}</td><td>${hS}:${aS}</td><td class="${res==='ìŠ¹'?'win':''}">${res}</td><td>${val > 0 ? val.toLocaleString() : "-"}</td><td>${m.bfcmanager || m.bfc_manager || "-"}</td></tr>`; 
        }).join('');
    }

    /* ë‚˜ë¨¸ì§€ í—¬í¼ í•¨ìˆ˜ë“¤(renderPlayerTable, getWithParticle, resetToAll ë“±) v22.2ì™€ ë™ì¼í•˜ê²Œ ìœ ì§€ */
    function getWithParticle(name, isResult = false) { if(!name) return ""; const charCode = name.charCodeAt(name.length - 1); const hasBatchim = (charCode - 0xAC00) % 28 > 0; return isResult ? (hasBatchim ? "ê³¼ì˜" : "ì™€ì˜") : (hasBatchim ? "ê³¼" : "ì™€"); }
    function fixAllTimeStats() { let w=0, d=0, l=0; rawData.forEach(m => { const isH = (m.hometeam || "").includes("ë¶€ì²œ"), myS = isH ? parseInt(m.homescored)||0 : parseInt(m.awayscored)||0, opS = isH ? parseInt(m.awayscored)||0 : parseInt(m.homescored)||0; if (myS > opS) w++; else if (myS < opS) l++; else d++; }); document.getElementById('stat-total').innerText = rawData.length + "ê²½ê¸°"; document.getElementById('stat-w').innerText = w + "ìŠ¹"; document.getElementById('stat-d').innerText = d + "ë¬´"; document.getElementById('stat-l').innerText = l + "íŒ¨"; document.getElementById('stat-rate').innerText = rawData.length ? (((w + d * 0.5) / rawData.length) * 100).toFixed(1) + "%" : "0%"; }
    function switchMode(m) { currentMode = m; resetToAll(); document.getElementById('team-section').style.display = m === 'team' ? 'block' : 'none'; document.getElementById('player-section').style.display = m === 'player' ? 'block' : 'none'; document.getElementById('mode-t').className = (m === 'team' ? 'mode-btn active' : 'mode-btn'); document.getElementById('mode-p').className = (m === 'player' ? 'mode-btn active' : 'mode-btn'); updateView(); }
    function initFilters() { const tY = [...new Set(rawData.map(m => (m.date || "").substring(0,4)))].sort(); const yS = document.getElementById('select-year'); if(yS) tY.forEach(y => yS.add(new Option(y, y))); const mgrs = [...new Set(rawData.map(m => m.bfcmanager || m.bfc_manager))].filter(Boolean).sort(); const mS = document.getElementById('select-manager'); if(mS) mgrs.forEach(m => mS.add(new Option(m, m))); }
    function toggleSort(col) { sortState.direction = (col === sortState.column && sortState.direction === 'desc') ? 'asc' : 'desc'; sortState.column = col; updateView(); }
    function resetToAll() { 
        currentFilter = { opponent: null, stadium: null, type: null, streakMatches: [] }; sortState = { column: 'date', direction: 'desc' };
        document.getElementById('team-filter-1').style.display = 'grid'; document.getElementById('team-filter-2').style.display = 'grid'; document.getElementById('team-notice').style.display = 'block';
        document.getElementById('dynamic-header').style.display='none'; 
        document.getElementById('team-section').style.display = currentMode === 'team' ? 'block' : 'none';
        document.getElementById('player-section').style.display = currentMode === 'player' ? 'block' : 'none';
        document.getElementById('mode-t').className = currentMode === 'team' ? 'mode-btn active' : 'mode-btn';
        document.getElementById('mode-p').className = currentMode === 'player' ? 'mode-btn active' : 'mode-btn';
        document.getElementById('mode-h').className = 'mode-btn history-btn';
        updateView(); 
    }
    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
    window.onload = loadData;
    /* (ì¤‘ëµ: calculateTotalRankings, showSuggestions ë“± ê¸°íƒ€ í•¨ìˆ˜ë“¤ v22.2ì™€ ë™ì¼í•˜ê²Œ í¬í•¨ë˜ì–´ì•¼ í•¨) */
</script>
</body>
</html>
