<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë¶€ì²œFC1995 ë°ì´í„° í¬í„¸</title>
    <style>
        /* [ìŠ¤íƒ€ì¼ ì •ì˜ ì˜ì—­] - ì„±í˜„ë‹˜ì˜ ëª¨ë“  ë””ìì¸ ê°€ì´ë“œ ìœ ì§€ */
        :root { 
            --bfc-red: #ed1c24; 
            --bfc-black: #1a1a1a; 
            --bg-gray: #f4f4f4; 
            --win-gold: #ffd700; 
        }

        body { 
            font-family: 'Pretendard', sans-serif; 
            margin: 0; 
            background-color: var(--bg-gray); 
            color: #333; 
            display: flex; 
            flex-direction: column; 
            min-height: 100vh; 
            -webkit-text-size-adjust: none; 
        }

        header { 
            background: linear-gradient(135deg, var(--bfc-black) 60%, var(--bfc-red)); 
            color: white; 
            padding: 40px 20px 60px; 
            text-align: center; 
            border-bottom: 6px solid var(--bfc-red); 
            position: relative; 
        }

        .home-link { 
            text-decoration: none; 
            color: white; 
            display: inline-flex; 
            align-items: center; 
            gap: 10px; 
            cursor: pointer; 
        }

        header h1 { 
            margin: 0; 
            font-size: 1.8rem; 
            font-weight: 900; 
        }

        .stats-dashboard { 
            background: rgba(255, 255, 255, 0.1); 
            margin: 20px auto 0; 
            padding: 12px 25px; 
            border-radius: 50px; 
            display: inline-block; 
            backdrop-filter: blur(5px); 
            border: 1px solid rgba(255, 255, 255, 0.2); 
            font-size: 0.9rem; 
        }

        .stats-dashboard span { 
            margin: 0 8px; 
            font-weight: 600; 
        }

        /* ì—°ì† ê¸°ë¡ ëŒ€ì‹œë³´ë“œ */
        .streak-container { 
            display: flex; 
            justify-content: center; 
            gap: 15px; 
            margin-top: 15px; 
            flex-wrap: wrap; 
        }

        .streak-badge { 
            background: rgba(0, 0, 0, 0.4); 
            padding: 10px 18px; 
            border-radius: 12px; 
            font-size: 0.85rem; 
            border: 1px solid rgba(255, 255, 255, 0.15); 
            cursor: pointer; 
            transition: 0.3s; 
            color: #eee; 
        }

        .streak-badge:hover { 
            background: rgba(255, 255, 255, 0.1); 
            border-color: var(--win-gold); 
            transform: translateY(-2px); 
        }

        .streak-badge b { 
            color: var(--win-gold); 
            font-size: 1rem; 
        }

        .streak-badge .current-label { 
            margin-left: 10px; 
            padding-left: 10px; 
            border-left: 1px solid rgba(255, 255, 255, 0.3); 
            color: #fff; 
            font-weight: bold; 
        }

        .mode-switch { 
            display: flex; 
            justify-content: center; 
            gap: 10px; 
            margin-top: -25px; 
            position: relative; 
            z-index: 100; 
        }

        .mode-btn { 
            background: white; 
            border: 2px solid var(--bfc-red); 
            color: var(--bfc-red); 
            padding: 12px 30px; 
            border-radius: 50px; 
            font-weight: 800; 
            cursor: pointer; 
            transition: 0.3s; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
        }

        .mode-btn.active { 
            background: var(--bfc-red); 
            color: white; 
        }

        .history-btn { 
            background: #ffd700; 
            border: 2px solid #b8860b; 
            color: #000; 
            margin-left: 10px; 
        }

        .history-btn.active { 
            background: #b8860b; 
            color: #fff; 
        }

        .away-btn { 
            background: var(--bfc-black); 
            border: 2px solid var(--bfc-black); 
            color: white; 
            height: 45px; 
            border-radius: 10px; 
            font-weight: 800; 
            cursor: pointer; 
            transition: 0.3s; 
            width: 100%; 
        }

        .container { 
            max-width: 1300px; 
            margin: 30px auto 50px; 
            padding: 0 15px; 
            flex: 1; 
            position: relative; 
            z-index: 10; 
        }

        .ranking-container { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 15px; 
            margin-bottom: 40px; 
        }

        .ranking-box { 
            background: white; 
            border-radius: 15px; 
            padding: 20px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); 
            border-top: 4px solid var(--bfc-black); 
            position: relative; 
        }

        .ranking-box h3 { 
            margin: 0 0 15px 0; 
            font-size: 0.95rem; 
            color: var(--bfc-red); 
        }

        .rank-item { 
            display: flex; 
            justify-content: space-between; 
            padding: 8px 0; 
            border-bottom: 1px solid #f0f0f0; 
            font-size: 0.85rem; 
        }

        .more-btn { 
            background: none; 
            border: none; 
            color: #999; 
            font-size: 0.75rem; 
            cursor: pointer; 
            float: right; 
            margin-top: -35px; 
        }

        .filter-container { 
            background: white; 
            border-radius: 15px; 
            padding: 25px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            gap: 15px; 
            align-items: end; 
        }

        .filter-item { 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
            position: relative; 
        }

        .filter-item label { 
            font-size: 0.85rem; 
            font-weight: bold; 
            color: #666; 
        }

        .checkbox-group { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 15px; 
            padding: 0 15px; 
            background: #f9f9f9; 
            border-radius: 10px; 
            border: 1px solid #ddd; 
            height: 45px; 
            align-items: center; 
            box-sizing: border-box; 
        }

        .checkbox-group label { 
            font-size: 0.85rem; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            white-space: nowrap; 
            line-height: 1; 
        }

        select, input { 
            padding: 12px; 
            border: 1px solid #ddd; 
            border-radius: 10px; 
            font-size: 0.95rem; 
            outline: none; 
            width: 100%; 
            box-sizing: border-box; 
            height: 45px; 
        }

        .search-results { 
            position: absolute; 
            background: white; 
            border: 1px solid #ddd; 
            border-radius: 10px; 
            width: 100%; 
            max-height: 200px; 
            overflow-y: auto; 
            z-index: 1000; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
            display: none; 
            margin-top: 75px; 
            list-style: none; 
            padding: 0; 
        }

        .search-results li { 
            padding: 10px 15px; 
            cursor: pointer; 
            font-size: 0.85rem; 
            border-bottom: 1px solid #f9f9f9; 
        }

        .search-results li:hover { 
            background-color: #f0f0f0; 
            color: var(--bfc-red); 
            font-weight: bold; 
        }

        .view-header { 
            margin-top: 20px; 
            background: white; 
            padding: 20px; 
            border-radius: 15px; 
            border-left: 6px solid var(--bfc-red); 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); 
            display: none; 
            flex-direction: column; 
            gap: 10px; 
        }

        .view-summary { 
            font-size: 0.95rem; 
            color: #555; 
            border-top: 1px dashed #eee; 
            padding-top: 10px; 
        }

        .view-summary span { 
            color: var(--bfc-red); 
            font-weight: bold; 
        }

        .results-box { 
            background: white; 
            border-radius: 15px; 
            margin-top: 15px; 
            overflow-x: auto; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); 
        }

        table { 
            width: 100%; 
            border-collapse: collapse; 
            min-width: 1100px; 
        }

        th { 
            background: #f8f9fa; 
            padding: 15px; 
            font-size: 0.75rem; 
            color: #555; 
            text-align: center; 
            cursor: pointer; 
        }

        td { 
            padding: 12px; 
            text-align: center; 
            border-bottom: 1px solid #f0f0f0; 
            font-size: 0.85rem; 
        }

        .clickable { 
            color: var(--bfc-black); 
            cursor: pointer; 
            text-decoration: underline; 
            text-decoration-color: #ddd; 
        }

        .win { 
            color: var(--bfc-red); 
            font-weight: bold; 
        }

        .highlight-red { 
            color: var(--bfc-red); 
            font-weight: bold; 
        }

        .streak-separator { 
            background-color: #fdf2f2 !important; 
            font-weight: bold; 
            color: var(--bfc-red); 
            font-size: 0.85rem; 
        }

        #modal-overlay { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.7); 
            z-index: 1000; 
            justify-content: center; 
            align-items: center; 
        }

        .modal-content { 
            background: white; 
            width: 95%; 
            max-width: 550px; 
            border-radius: 30px; 
            padding: 40px; 
            position: relative; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.2); 
        }

        .modal-header { 
            text-align: center; 
            border-bottom: 3px solid var(--bfc-red); 
            padding-bottom: 20px; 
            margin-bottom: 30px; 
        }

        .modal-header h2 { 
            margin: 0; 
            font-size: 1.6rem; 
            font-weight: 900; 
            color: var(--bfc-black); 
        }

        .modal-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 15px; 
        }

        .modal-item-full { 
            grid-column: span 2; 
        }

        .stat-card { 
            background: #f8f9fa; 
            border-radius: 15px; 
            padding: 20px; 
            text-align: center; 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
        }

        .stat-label { 
            font-size: 0.85rem; 
            color: #888; 
            font-weight: 500; 
        }

        .stat-value { 
            font-size: 1.3rem; 
            font-weight: 800; 
            color: var(--bfc-red); 
        }

        .rate-small { 
            font-size: 0.75rem; 
            color: #666; 
            font-weight: 400; 
            margin-top: -4px; 
        }

        .data-notice { 
            margin: 15px 0 25px; 
            padding: 15px 20px; 
            background: #fff; 
            border-radius: 15px; 
            border-left: 5px solid var(--bfc-red); 
            font-size: 0.85rem; 
            color: #666; 
            line-height: 1.6; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.03); 
        }

        footer { 
            background-color: var(--bfc-black); 
            color: #999; 
            text-align: center; 
            padding: 40px 20px; 
            margin-top: auto; 
            line-height: 1.8; 
        }

        @media (max-width: 768px) {
            header h1 { font-size: 1.4rem; }
            .mode-btn { padding: 10px 5px; font-size: 0.75rem; }
            .ranking-container { grid-template-columns: repeat(2, 1fr); }
            .filter-container { grid-template-columns: 1fr !important; }
        }
    </style>
</head>
<body>

<div id="modal-overlay" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <span style="position:absolute; top:15px; right:20px; font-size:1.5rem; cursor:pointer; color:#999;" onclick="closeModal()">&times;</span>
        <div id="modal-data"></div>
    </div>
</div>

<header>
    <a href="javascript:void(0)" onclick="resetToAll()" class="home-link"><h1>ë¶€ì²œFC1995 ë°ì´í„° í¬í„¸</h1></a>
    <div id="today-date" style="margin-top: 10px; font-size: 1rem; opacity: 0.8;"></div>
    <div class="stats-dashboard">
        <span>í†µì‚°</span><span id="stat-total">0ê²½ê¸°</span> | 
        <span id="stat-w">0ìŠ¹</span> 
        <span id="stat-d">0ë¬´</span> 
        <span id="stat-l">0íŒ¨</span> | 
        <span id="stat-gf">0ë“</span> 
        <span id="stat-ga">0ì‹¤</span> | 
        <span>ìŠ¹ë¥ </span><span id="stat-rate">0%</span>
    </div>
    
    <div class="streak-container">
        <div class="streak-badge" onclick="showStreakDetail('win')">
            ì—­ëŒ€ ìµœë‹¤ì—°ìŠ¹ ë³´ëŸ¬ê°€ê¸° (<b id="best-win-streak">0</b>ê²½ê¸°)
            <span id="cur-win-label" class="current-label" style="display:none;">í˜„ì¬ <span id="cur-win-val"></span>ì—°ìŠ¹ ì§„í–‰ì¤‘! ğŸ”¥</span>
        </div>
        <div class="streak-badge" onclick="showStreakDetail('unbeaten')">
            ì—­ëŒ€ ìµœë‹¤ ë¬´íŒ¨ ë³´ëŸ¬ê°€ê¸° (<b id="best-unbeaten-streak">0</b>ê²½ê¸°)
            <span id="cur-unbeaten-label" class="current-label" style="display:none;">í˜„ì¬ <span id="cur-unbeaten-val"></span>ê²½ê¸° ë¬´íŒ¨ ì§„í–‰ì¤‘! ğŸ”¥</span>
        </div>
    </div>
</header>

<div class="mode-switch">
    <button id="mode-t" class="mode-btn active" onclick="switchMode('team')">ğŸŸï¸ íŒ€ ê²½ê¸° ê¸°ë¡</button>
    <button id="mode-p" class="mode-btn" onclick="switchMode('player')">ğŸƒâ€â™‚ï¸ ì„ ìˆ˜ ê°œì¸ ê¸°ë¡</button>
    <button id="mode-h" class="mode-btn history-btn" onclick="showHistorySection()">ğŸ“œ TODAY'S HISTORY</button>
</div>

<div class="container">
    <div id="team-section">
        <div id="team-filter-1" class="filter-container">
            <div class="filter-item"><label>ì‹œì¦Œë³„</label><select id="select-year" onchange="updateView()"><option value="">ì „ì²´ ì‹œì¦Œ</option></select></div>
            <div class="filter-item"><label>í™ˆ/ì›ì •</label><select id="select-location" onchange="updateView()"><option value="">ì „ì²´</option><option value="home">í™ˆ ê²½ê¸°</option><option value="away">ì›ì • ê²½ê¸°</option></select></div>
            <div class="filter-item"><label>ê°ë…ë³„</label><select id="select-manager" onchange="updateView()"><option value="">ëª¨ë“  ê°ë…</option></select></div>
            <div class="filter-item">
                <label>ëŒ€íšŒë³„ ì¡°íšŒ</label>
                <select id="select-league" onchange="updateView()">
                    <option value="">ëª¨ë“  ëŒ€íšŒ</option>
                    <option value="Kë¦¬ê·¸1">Kë¦¬ê·¸1</option>
                    <option value="Kë¦¬ê·¸2">Kë¦¬ê·¸2</option>
                    <option value="K3ë¦¬ê·¸">K3ë¦¬ê·¸</option>
                    <option value="í”Œë ˆì´ì˜¤í”„">í”Œë ˆì´ì˜¤í”„</option>
                    <option value="ì½”ë¦¬ì•„ì»µ">ì½”ë¦¬ì•„ì»µ</option>
                    <option value="ì±Œë¦°ì €ìŠ¤ì»µ">ì±Œë¦°ì €ìŠ¤ì»µ</option>
                </select>
            </div>
        </div>
        <div id="team-filter-2" class="filter-container" style="margin-top: 15px; grid-template-columns: repeat(4, 1fr);">
            <div class="filter-item"><label>ìƒëŒ€íŒ€ ê²€ìƒ‰</label><input type="text" id="search-opponent" placeholder="íŒ€ëª… ì…ë ¥" onkeyup="showSuggestions(this, 'opponentName')" autocomplete="off"><ul class="search-results"></ul></div>
            <div class="filter-item"><label>ìƒëŒ€ê°ë… ê²€ìƒ‰</label><input type="text" id="search-opp-manager" placeholder="ê°ë…ëª… ì…ë ¥" onkeyup="showSuggestions(this, 'opp_manager')" autocomplete="off"><ul class="search-results"></ul></div>
            <div class="filter-item"><label>ì£¼ì‹¬ ê²€ìƒ‰</label><input type="text" id="search-referee" placeholder="ì£¼ì‹¬ ì„±í•¨ ì…ë ¥" onkeyup="showSuggestions(this, 'referee')" autocomplete="off"><ul class="search-results"></ul></div>
            <div class="filter-item"><button id="btn-away-fan" class="away-btn" onclick="showAwayFanSection()">ğŸšŒ í•¨ê»˜í–ˆë˜ ì›ì •íŒ¬ ì¡°íšŒ</button></div>
        </div>
        <div id="team-notice" class="data-notice">
            â€¢ íŒ€ ê²½ê¸°ê¸°ë¡ì€ 2007ë…„ ì°½ë‹¨ ì´í›„ ë¶€ì²œFC1995ì˜ ëª¨ë“  ê³µì‹ ëŒ€íšŒ ë°ì´í„°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì œê³µí•©ë‹ˆë‹¤. <br>
            â€¢ í˜„ì¬ ëŒ€í•œì¶•êµ¬í˜‘íšŒì—ì„œ ì œê³µë˜ì§€ ì•ŠëŠ” ê³¼ê±° ë°ì´í„°(ê´€ì¤‘ìˆ˜, ì‹¬íŒ ì •ë³´)ëŠ” ì¼ë¶€ ëˆ„ë½ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
        </div>
    </div>

    <div id="player-section" style="display: none;">
        <div id="player-ranking-panel">
            <div class="ranking-container">
                <div class="ranking-box"><h3>ğŸƒâ€â™‚ï¸ í†µì‚° ì¶œì „ TOP 7</h3><button class="more-btn" onclick="showAllRankings('match')">more</button><div id="rank-match"></div></div>
                <div class="ranking-box"><h3>âš½ í†µì‚° ë“ì  TOP 7</h3><button class="more-btn" onclick="showAllRankings('goal')">more</button><div id="rank-goal"></div></div>
                <div class="ranking-box"><h3>ğŸ”¥ í¬ì¸íŠ¸ TOP 7</h3><button class="more-btn" onclick="showAllRankings('ap')">more</button><div id="rank-ap"></div></div>
                <div class="ranking-box"><h3>ğŸ§¤ í´ë¦°ì‹œíŠ¸ TOP 7</h3><button class="more-btn" onclick="showAllRankings('cs')">more</button><div id="rank-cs"></div></div>
            </div>
        </div>
        <div class="filter-container" style="grid-template-columns: 1fr 1.2fr 2.8fr;">
            <div class="filter-item"><label>ì‹œì¦Œ ì„ íƒ</label><select id="p-select-year" onchange="updateView()"><option value="">ì „ì²´ ì‹œì¦Œ</option></select></div>
            <div class="filter-item"><label>ì„ ìˆ˜ëª… ê²€ìƒ‰</label><input type="text" id="p-search-name" placeholder="ì´ë¦„ ì…ë ¥" onkeyup="showSuggestions(this, 'playerName')" autocomplete="off"><ul class="search-results"></ul></div>
            <div class="filter-item">
                <label>ëŒ€íšŒ ì„ íƒ</label>
                <div class="checkbox-group">
                    <label><input type="checkbox" id="check-all" checked onclick="toggleAllLeagues(this)"> ì „ì²´ì„ íƒ</label>
                    <label><input type="checkbox" name="p-league" value="Kë¦¬ê·¸1" checked onchange="updateSubLeagues()"> Kë¦¬ê·¸1</label>
                    <label><input type="checkbox" name="p-league" value="Kë¦¬ê·¸2" checked onchange="updateSubLeagues()"> Kë¦¬ê·¸2</label>
                    <label><input type="checkbox" name="p-league" value="í”Œë ˆì´ì˜¤í”„" checked onchange="updateSubLeagues()"> í”Œë ˆì´ì˜¤í”„</label>
                    <label><input type="checkbox" name="p-league" value="ì½”ë¦¬ì•„ì»µ" checked onchange="updateSubLeagues()"> ì½”ë¦¬ì•„ì»µ</label>
                </div>
            </div>
        </div>
        <div class="data-notice">
            <b>ğŸ’¡ ë°ì´í„° ì•ˆë‚´</b><br>
            â€¢ ì„ ìˆ˜ í†µì‚° ê¸°ë¡ì€ ë¶€ì²œ ì†Œì†ìœ¼ë¡œ ì¶œì „í•œ ê³µì‹ ê²½ê¸° ê¸°ë¡ë§Œ í•©ì‚°í•˜ë©°, 2013ë…„ í”„ë¡œ ì§„ì¶œ ì´í›„ ê¸°ë¡ë§Œ ì œê³µí•˜ê³  ìˆìŠµë‹ˆë‹¤. <br>
            â€¢ ê° í—¤ë”ë¥¼ í´ë¦­í•˜ì‹œë©´, ìµœë‹¤ê¸°ë¡ ìˆœìœ¼ë¡œ ì¡°íšŒê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤. <br>
            â€¢ ì„ ìˆ˜ ì´ë¦„ì„ í´ë¦­í•˜ì‹œë©´, ì„ ìˆ˜ ê°œì¸ì˜ ë¶€ì²œ í†µì‚° ê¸°ë¡ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>
    </div>

    <div id="dynamic-header" class="view-header">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div id="dynamic-title" style="font-weight:bold; font-size:1.1rem; word-break:keep-all;"></div>
            <button class="mode-btn" style="padding: 5px 15px; font-size: 0.8rem; flex:none;" onclick="resetToAll()">ì´ì „ ê²°ê³¼ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
        <div id="dynamic-summary" class="view-summary"></div>
    </div>
    <div class="results-box">
        <table>
            <thead id="table-head"></thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>
</div>

<footer>
    <p>ë¶€ì²œFC1995 ë°ì´í„° í¬í„¸ì€ ê°œì¸ì´ ìš´ì˜í•˜ëŠ” í˜ì´ì§€ì…ë‹ˆë‹¤.<br>
ëŒ€í•œì¶•êµ¬í˜‘íšŒ, í•œêµ­í”„ë¡œì¶•êµ¬ì—°ë§¹ ê³µì‹ê¸°ë¡ì„ ë°”íƒ•ìœ¼ë¡œ ìµœëŒ€í•œì˜ ì •í™•ì„±ì„ ì¶”êµ¬í•˜ë‚˜ ìë£Œì— ì˜¤ë¥˜ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
ë¬¸ì˜ì‚¬í•­ì´ë‚˜ ì˜¤ë¥˜ ë°œê²¬ì‚¬í•­ì´ ìˆìœ¼ì‹¤ ê²½ìš° ì•„ë˜ ë©”ì¼ë¡œ ì—°ë½ ë¶€íƒë“œë¦½ë‹ˆë‹¤.<br>
ë¬¸ì˜: namakear@naver.com <br> Â© 2026 BFC1995 ë°ì´í„° í¬í„¸. All Rights Reserved.</p>
</footer>

<script>
    const TEAM_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQTLnO6CTQkcgJTDHr0MNJAA5xUCCWSqWSq-fgvJkEIGRrOBH1D9EXNXJLxIAriWiQ1oMrSKxTq6Y8m/pub?gid=0&single=true&output=csv";
    const PLAYER_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQTLnO6CTQkcgJTDHr0MNJAA5xUCCWSqWSq-fgvJkEIGRrOBH1D9EXNXJLxIAriWiQ1oMrSKxTq6Y8m/pub?gid=1150204300&single=true&output=csv";
    
    let rawData = [], playerSeasonData = [], currentMode = 'team';
    let sortState = { column: 'date', direction: 'desc' };
    let currentFilter = { opponent: null, stadium: null, type: null, streakPools: [] }; 
    let isTotalRankMode = false, selectedPlayerSearchName = ""; 
    let bestWinStreakGroups = [], bestUnbeatenStreakGroups = [];

    async function loadData() {
        try {
            const [tRes, pRes] = await Promise.all([
                fetch(TEAM_URL + "&cb=" + Date.now()), 
                fetch(PLAYER_URL + "&cb=" + Date.now())
            ]);
            rawData = parseCSV(await tRes.text()); 
            playerSeasonData = parseCSV(await pRes.text());
            
            const now = new Date(); 
            document.getElementById('today-date').innerText = `${now.getFullYear()}ë…„ ${now.getMonth() + 1}ì›” ${now.getDate()}ì¼ ê¸°ì¤€`;
            
            fixAllTimeStats(); 
            calculateStreaks(); 
            calculateTotalRankings(); 
            initFilters(); 
            updateView();
        } catch (e) { console.error("Load Error", e); }
    }

    function parseCSV(text) {
        const rows = text.split(/\r?\n/).filter(l => l.trim() !== "");
        if (rows.length < 1) return [];
        const heads = rows[0].split(',').map(h => h.trim().toLowerCase().replace(/[^\w]/gi, ''));
        return rows.slice(1).map(line => {
            const vals = []; 
            let start = 0, inQ = false;
            for (let i = 0; i < line.length; i++) { 
                if (line[i] === '"') inQ = !inQ; 
                if (line[i] === ',' && !inQ) { vals.push(line.substring(start, i)); start = i + 1; } 
            }
            vals.push(line.substring(start)); 
            let o = {};
            heads.forEach((h, i) => o[h] = (vals[i] || "").trim().replace(/^"|"$/g, "").trim()); 
            return o;
        });
    }

    function fixAllTimeStats() {
        let w=0, d=0, l=0, gf=0, ga=0;
        rawData.forEach(m => {
            const isH = (m.hometeam || "").includes("ë¶€ì²œ");
            const hS = parseInt(m.homescored)||0, aS = parseInt(m.awayscored)||0;
            const myS = isH ? hS : aS, opS = isH ? aS : hS;
            gf += myS; ga += opS; 
            if (myS > opS) w++; 
            else if (myS < opS) l++; 
            else d++;
        });
        document.getElementById('stat-total').innerText = rawData.length + "ê²½ê¸°";
        document.getElementById('stat-w').innerText = w + "ìŠ¹"; 
        document.getElementById('stat-d').innerText = d + "ë¬´";
        document.getElementById('stat-l').innerText = l + "íŒ¨";
        document.getElementById('stat-gf').innerText = gf + "ë“";
        document.getElementById('stat-ga').innerText = ga + "ì‹¤";
        document.getElementById('stat-rate').innerText = rawData.length ? (((w + d * 0.5) / rawData.length) * 100).toFixed(1) + "%" : "0%";
    }

    function getUnifiedTeamName(n) {
        if(!n) return "";
        const mapping = {
            "ìƒì£¼ ìƒë¬´": "ìƒë¬´ ì¶•êµ¬ë‹¨", "ìƒì£¼ìƒë¬´": "ìƒë¬´ ì¶•êµ¬ë‹¨", "ê¹€ì²œ ìƒë¬´": "ìƒë¬´ ì¶•êµ¬ë‹¨", "ê¹€ì²œìƒë¬´": "ìƒë¬´ ì¶•êµ¬ë‹¨", "ê´‘ì£¼ ìƒë¬´": "ìƒë¬´ ì¶•êµ¬ë‹¨", "ê´‘ì£¼ìƒë¬´": "ìƒë¬´ ì¶•êµ¬ë‹¨",
            "ì•„ì‚° ìœ ë‚˜ì´í‹°ë“œ": "ì•„ì‚° ì‹œë¯¼ì¶•êµ¬ë‹¨", "ì•„ì‚° ì‹œë¯¼ì¶•êµ¬ë‹¨": "ì•„ì‚° ì‹œë¯¼ì¶•êµ¬ë‹¨", "ì¶©ë‚¨ ì•„ì‚°": "ì¶©ë‚¨ ì•„ì‚° FC", "ì¶©ë‚¨ì•„ì‚°": "ì¶©ë‚¨ ì•„ì‚° FC",
            "ì²œì•ˆì‹œì²­": "ì²œì•ˆì‹œí‹°FC", "ì²œì•ˆì‹œí‹°FC": "ì²œì•ˆì‹œí‹°FC",
            "í™”ì„± ì‹ ìš°ì „ì": "ì‹ ìš°ì „ì ì¶•êµ¬ë‹¨", "ì‚¼ì²™ ì‹ ìš°ì „ì": "ì‹ ìš°ì „ì ì¶•êµ¬ë‹¨",
            "ê³ ì–‘ Hi FC": "ê³ ì–‘ ìì´í¬ë¡œ", "ê³ ì–‘ ìì´í¬ë¡œ": "ê³ ì–‘ ìì´í¬ë¡œ",
            "ê²½ì°° ì¶•êµ¬ë‹¨": "ê²½ì°° ì¶•êµ¬ë‹¨", "ì•ˆì‚° ë¬´ê¶í™”": "ê²½ì°° ì¶•êµ¬ë‹¨", "ì•„ì‚° ë¬´ê¶í™”": "ê²½ì°° ì¶•êµ¬ë‹¨",
            "ëŒ€ì „ ì‹œí‹°ì¦Œ": "ëŒ€ì „ í•˜ë‚˜ì‹œí‹°ì¦Œ", "ëŒ€ì „ í•˜ë‚˜ì‹œí‹°ì¦Œ": "ëŒ€ì „ í•˜ë‚˜ì‹œí‹°ì¦Œ",
            "ì œì£¼ SK": "SK ì¶•êµ¬ë‹¨", "ì œì£¼ ìœ ë‚˜ì´í‹°ë“œ": "SK ì¶•êµ¬ë‹¨"
        };
        return mapping[n] || n;
    }

    function getWithParticle(name, isResult = false) {
        if(!name) return ""; 
        const charCode = name.charCodeAt(name.length - 1); 
        const hasBatchim = (charCode - 0xAC00) % 28 > 0;
        return isResult ? (hasBatchim ? "ê³¼ì˜" : "ì™€ì˜") : (hasBatchim ? "ê³¼" : "ì™€");
    }

    function calculateStreaks() {
        if (!rawData.length) return;
        const sorted = [...rawData].sort((a, b) => new Date(a.date) - new Date(b.date));
        let winPools = [], unbeatenPools = [];
        let curW = [], curU = [];

        sorted.forEach(m => {
            const isH = (m.hometeam || "").includes("ë¶€ì²œ"), myS = isH ? parseInt(m.homescored)||0 : parseInt(m.awayscored)||0, opS = isH ? parseInt(m.awayscored)||0 : parseInt(m.homescored)||0;
            if (myS > opS) { curW.push(m); } 
            else { if(curW.length > 1) winPools.push([...curW]); curW = []; }
            
            if (myS >= opS) { curU.push(m); } 
            else { if(curU.length > 1) unbeatenPools.push([...curU]); curU = []; }
        });
        if(curW.length > 1) winPools.push(curW); 
        if(curU.length > 1) unbeatenPools.push(curU);

        const maxW = Math.max(...winPools.map(p => p.length), 0), maxU = Math.max(...unbeatenPools.map(p => p.length), 0);
        bestWinStreakGroups = winPools.filter(p => p.length === maxW); bestUnbeatenStreakGroups = unbeatenPools.filter(p => p.length === maxU);
        
        document.getElementById('best-win-streak').innerText = maxW; 
        document.getElementById('best-unbeaten-streak').innerText = maxU;
        
        const lastG = sorted[sorted.length - 1];
        const ongoingW = winPools.find(p => p.includes(lastG)), ongoingU = unbeatenPools.find(p => p.includes(lastG));
        if(ongoingW) { document.getElementById('cur-win-label').style.display = 'inline'; document.getElementById('cur-win-val').innerText = ongoingW.length; }
        if(ongoingU) { document.getElementById('cur-unbeaten-label').style.display = 'inline'; document.getElementById('cur-unbeaten-val').innerText = ongoingU.length; }
    }

    function renderTeamTable() {
        const year = document.getElementById('select-year').value, loc = document.getElementById('select-location').value, mgr = document.getElementById('select-manager').value, selLg = document.getElementById('select-league').value;
        const sOpp = (document.getElementById('search-opponent')?.value || "").trim(), sOppMgr = (document.getElementById('search-opp-manager')?.value || "").trim(), sRef = (document.getElementById('search-referee')?.value || "").trim();
        const header = document.getElementById('dynamic-header'), titleEl = document.getElementById('dynamic-title'), summary = document.getElementById('dynamic-summary');
        let filtered = []; let isMultiStreak = false;

        if (currentFilter.type === 'opening_match') {
            header.style.display = "flex"; titleEl.innerText = `ğŸ” ë¶€ì²œFC1995 ì—­ëŒ€ ë¦¬ê·¸ ê°œë§‰ì „ ê²½ê¸°ê²°ê³¼`;
            const yearGroups = {};
            rawData.forEach(m => { if (m.league.includes("ë¦¬ê·¸")) { const y = m.date.substring(0, 4); if (!yearGroups[y] || new Date(m.date) < new Date(yearGroups[y].date)) { yearGroups[y] = m; } } });
            filtered = Object.values(yearGroups).filter(m => (!loc || (loc === 'home' ? (m.hometeam||"").includes("ë¶€ì²œ") : !(m.hometeam||"").includes("ë¶€ì²œ"))) && (!mgr || (m.bfcmanager || m.bfc_manager) === mgr) && (!year || m.date.startsWith(year)));
        } else if (currentFilter.type === 'away_fan') {
            header.style.display = "flex"; titleEl.innerText = `ğŸ” ë¶€ì²œFC1995 ì›ì •ê²½ê¸°ì— í•¨ê»˜í•œ ì›ì •ê´€ì¤‘ ê¸°ë¡`;
            filtered = rawData.filter(m => !(m.hometeam || "").includes("ë¶€ì²œ") && parseInt(m.date.substring(0,4)) >= 2023);
        } else if (currentFilter.type === 'streak_multi') {
            isMultiStreak = true; header.style.display = "flex";
            const count = currentFilter.streakPools[0].length;
            titleEl.innerText = (currentFilter.streakPools === bestWinStreakGroups) ? `ğŸ† ì—­ëŒ€ ìµœë‹¤ ${count}ì—°ìŠ¹ ê¸°ë¡ (${currentFilter.streakPools.length}ê±´)` : `ğŸ”¥ ì—­ëŒ€ ìµœë‹¤ ${count}ê²½ê¸° ë¬´íŒ¨ ê¸°ë¡ (${currentFilter.streakPools.length}ê±´)`;
            summary.innerHTML = "ì¤‘ë³µëœ ìµœë‹¤ ê¸°ë¡ì´ ìˆì„ ê²½ìš° ì‹œê¸°ë³„ë¡œ êµ¬ë¶„í•˜ì—¬ í‘œì‹œí•©ë‹ˆë‹¤.";
        } else {
            const hasFilter = currentFilter.opponent || currentFilter.stadium || year || mgr || selLg || sOpp || sOppMgr || sRef;
            if (hasFilter) {
                header.style.display = "flex";
                const tOpp = getUnifiedTeamName(sOpp || currentFilter.opponent), bfcMgr = mgr, oppMgr = sOppMgr, ref = sRef, lg = selLg;
                let titleStr = "";
                if (ref) titleStr = `${ref} ì£¼ì‹¬ì´ ì§„í–‰í•œ ê²½ê¸° ê²°ê³¼`;
                else if (bfcMgr && oppMgr) titleStr = `${oppMgr} ê°ë…ê³¼ ${bfcMgr} ê°ë…ì˜ ë§ëŒ€ê²° ê²°ê³¼`;
                else if (oppMgr && tOpp) titleStr = `${tOpp}ì˜ ${oppMgr} ê°ë…ì„ ìƒëŒ€ë¡œ í•œ ê²½ê¸° ê²°ê³¼`;
                else if (oppMgr) titleStr = `${oppMgr} ê°ë…ê³¼ì˜ ê²½ê¸° ê²°ê³¼`;
                else if (tOpp && bfcMgr && lg) titleStr = `${tOpp}${getWithParticle(tOpp)} ${bfcMgr} ê°ë…ì˜ ${lg} ê²½ê¸° ê²°ê³¼`;
                else if (tOpp && bfcMgr) titleStr = `${tOpp}${getWithParticle(tOpp)} ${bfcMgr} ê°ë…ì˜ ê²½ê¸° ê²°ê³¼`;
                else if (tOpp && lg) titleStr = `${tOpp}${getWithParticle(tOpp, true)} ${lg} ê²½ê¸° ê²°ê³¼`;
                else if (tOpp) titleStr = `${tOpp}${getWithParticle(tOpp, true)} ê²½ê¸° ê²°ê³¼`;
                else if (bfcMgr && lg) titleStr = `${bfcMgr} ê°ë…ì˜ ${lg} ê²½ê¸° ê²°ê³¼`;
                else if (bfcMgr) titleStr = `${bfcMgr} ê°ë…ì˜ ê²½ê¸° ê²°ê³¼`;
                else if (lg) titleStr = `ì—­ëŒ€ ${lg} ê²½ê¸° ê²°ê³¼`;
                else titleStr = "ì¡°íšŒ ê²°ê³¼";
                titleEl.innerText = `ğŸ” ${titleStr}${year ? ` (${year}ì‹œì¦Œ)` : ""}`;
            } else header.style.display = "none";
            filtered = rawData.filter(m => {
                const h = (m.hometeam || ""), a = (m.awayteam || ""), isH = h.includes("ë¶€ì²œ"), oppUnified = getUnifiedTeamName(isH ? a : h);
                if (currentFilter.opponent && oppUnified !== getUnifiedTeamName(currentFilter.opponent)) return false;
                if (sOpp && !oppUnified.includes(getUnifiedTeamName(sOpp)) && !oppRaw.includes(sOpp)) return false; 
                if (sOppMgr && !(m.opp_manager || "").includes(sOppMgr)) return false; 
                if (sRef && !(m.referee || "").includes(sRef)) return false;
                if (year && !m.date.startsWith(year)) return false; 
                if (mgr && (m.bfcmanager || m.bfc_manager) === mgr) return false;
                if (loc && (loc === 'home' ? !isH : isH)) return false; 
                if (selLg && getUnifiedLeagueName(m.league) !== selLg) return false; return true;
            });
        }

        if(header.style.display !== "none" && !isMultiStreak) {
            let tw=0, td=0, tl=0, tgf=0, tga=0; 
            filtered.forEach(m => { 
                const isH = (m.hometeam || "").includes("ë¶€ì²œ"), hS = parseInt(m.homescored)||0, aS = parseInt(m.awayscored)||0, myS = isH ? hS : aS, opS = isH ? aS : hS; 
                tgf += myS; tga += opS; if (myS > opS) tw++; else if (myS < opS) tl++; else td++; 
            });
            const rate = filtered.length ? (((tw + td * 0.5) / filtered.length) * 100).toFixed(1) : 0;
            if (currentFilter.type === 'away_fan') summary.innerHTML = `â€¢ ì›ì •ê´€ì¤‘ìˆ˜ ê¸°ë¡ì€ 2023ë…„ ì´í›„ Kë¦¬ê·¸ ê²½ê¸°ì—ì„œë§Œ ë°œí‘œë˜ê³  ìˆìŠµë‹ˆë‹¤.`;
            else summary.innerHTML = `ì¡°íšŒ ê²°ê³¼: <span>${filtered.length}ê²½ê¸° ${tw}ìŠ¹ ${td}ë¬´ ${tl}íŒ¨</span> (${tgf}ë“ì  ${tga}ì‹¤ì ) - ìŠ¹ë¥  ${rate}%`;
            summary.style.display = 'block';
        }

        const isAwayMode = currentFilter.type === 'away_fan';
        document.getElementById('table-head').innerHTML = `<tr><th onclick="toggleSort('date')">ë‚ ì§œ â†•</th><th>ëŒ€íšŒ</th><th>ìƒëŒ€</th><th>ì¥ì†Œ</th><th>ìŠ¤ì½”ì–´</th><th>ê²°ê³¼</th><th onclick="toggleSort('${isAwayMode ? 'awayfan' : 'attendance'}')">${isAwayMode ? 'ì›ì •íŒ¬' : 'ê´€ì¤‘'} â†•</th><th>ê°ë…</th></tr>`;
        
        let html = "";
        if (isMultiStreak) {
            currentFilter.streakPools.forEach((pool, idx) => {
                html += `<tr class="streak-separator"><td colspan="8">ì‹œê¸° #${idx+1} (${pool[0].date} ~ ${pool[pool.length-1].date})</td></tr>`;
                pool.forEach(m => html += renderTeamRow(m, isAwayMode));
            });
        } else {
            const dData = [...filtered].sort((a,b) => {
                let vA = a[sortState.column], vB = b[sortState.column];
                if(sortState.column === 'attendance' || sortState.column === 'awayfan') { 
                    vA = parseInt(String(vA).replace(/,/g,''))||0; vB = parseInt(String(vB).replace(/,/g,''))||0; 
                    if (sortState.direction === 'asc') return (vA || Infinity) - (vB || Infinity); 
                }
                return sortState.direction === 'asc' ? (vA > vB ? 1 : -1) : (vA < vB ? 1 : -1);
            });
            dData.forEach(m => html += renderTeamRow(m, isAwayMode));
        }
        document.getElementById('table-body').innerHTML = html;
    }

    function renderTeamRow(m, isAwayMode) {
        const isH = (m.hometeam || "").includes("ë¶€ì²œ"), hS = parseInt(m.homescored)||0, aS = parseInt(m.awayscored)||0, res = (isH?hS:aS) > (isH?aS:hS) ? "ìŠ¹" : ((isH?hS:aS) < (isH?aS:hS) ? "íŒ¨" : "ë¬´");
        const val = isAwayMode ? (parseInt(m.awayfan)||0) : (parseInt(String(m.attendance).replace(/,/g,''))||0);
        return `<tr><td>${m.date}</td><td>${m.league}</td><td><b class="clickable" onclick="filterByOpponent('${isH?m.awayteam:m.hometeam}')">${isH?m.awayteam:m.hometeam}</b></td><td>${m.stadium || "-"}</td><td>${hS}:${aS}</td><td class="${res==='ìŠ¹'?'win':''}">${res}</td><td class="${isAwayMode?'highlight-red':''}">${val > 0 ? val.toLocaleString() : "-"}</td><td>${m.bfcmanager || m.bfc_manager || "-"}</td></tr>`;
    }

    function renderPlayerTable() {
        const year = document.getElementById('p-select-year').value, selectedLeagues = Array.from(document.querySelectorAll('input[name="p-league"]:checked')).map(cb => cb.value);
        const header = document.getElementById('dynamic-header'), summary = document.getElementById('dynamic-summary'), panel = document.getElementById('player-ranking-panel');
        if (year || selectedPlayerSearchName) { header.style.display = "flex"; panel.style.display = "none"; summary.style.display = "none"; document.getElementById('dynamic-title').innerText = `ğŸ” ì„ ìˆ˜ ê¸°ë¡ ì¡°íšŒ ê²°ê³¼`; }
        else { header.style.display = "none"; panel.style.display = "block"; }
        document.getElementById('table-head').innerHTML = `<tr><th onclick="toggleSort('season')">ì‹œì¦Œ â†•</th><th>ì´ë¦„</th><th>ëŒ€íšŒ</th><th onclick="toggleSortOnlyDesc('match')">ê²½ê¸° â†•</th><th onclick="toggleSortOnlyDesc('goal')">ë“ì  â†•</th><th onclick="toggleSortOnlyDesc('assist')">ë„ì›€ â†•</th><th onclick="toggleSortOnlyDesc('ap')">í¬ì¸íŠ¸ â†•</th><th onclick="toggleSortOnlyDesc('pk')">PK â†•</th><th onclick="toggleSortOnlyDesc('cs')">í´ë¦°ì‹œíŠ¸ â†•</th><th onclick="toggleSortOnlyDesc('yc')">ê²½ê³  â†•</th><th onclick="toggleSortOnlyDesc('rc')">í‡´ì¥ â†•</th></tr>`;
        let filtered = playerSeasonData.filter(p => (!year || p.season === year) && (!selectedPlayerSearchName || p.name === selectedPlayerSearchName) && selectedLeagues.includes(getUnifiedLeagueName(p.league)));
        const grouped = {};
        filtered.forEach(p => {
            const key = `${p.name}_${p.season}`; if (!grouped[key]) grouped[key] = { name: p.name, season: p.season, match: 0, goal: 0, assist: 0, pk: 0, cs: 0, yc: 0, rc: 0, details: {} };
            const uniLg = getUnifiedLeagueName(p.league); if (!grouped[key].details[uniLg]) grouped[key].details[uniLg] = { m: 0, g: 0, a: 0, pk: 0, cs: 0, yc: 0, rc: 0 };
            grouped[key].match += parseInt(p.match)||0; grouped[key].goal += parseInt(p.goal)||0; grouped[key].assist += parseInt(p.assist)||0; grouped[key].pk += parseInt(p.pk)||0; grouped[key].cs += parseInt(p.cleansheet)||0; grouped[key].yc += parseInt(p.yc)||0; grouped[key].rc += parseInt(p.rc)||0;
            grouped[key].details[uniLg].m += parseInt(p.match)||0; grouped[key].details[uniLg].g += parseInt(p.goal)||0; grouped[key].details[uniLg].a += parseInt(p.assist)||0; grouped[key].details[uniLg].pk += parseInt(p.pk)||0; grouped[key].details[uniLg].cs += parseInt(p.cleansheet)||0; grouped[key].details[uniLg].yc += parseInt(p.yc)||0; grouped[key].details[uniLg].rc += parseInt(p.rc)||0;
        });
        let dData = Object.values(grouped).sort((a,b) => sortState.column === 'season' ? (sortState.direction === 'asc' ? a.season - b.season : b.season - a.season) : (b[sortState.column] - a[sortState.column]));
        document.getElementById('table-body').innerHTML = dData.map(p => {
            const shownLgs = Object.keys(p.details); const totalLgs = [...new Set(playerSeasonData.filter(d => d.name === p.name && d.season === p.season).map(d => getUnifiedLeagueName(d.league)))];
            const sumText = shownLgs.length === 1 ? shownLgs[0] : (totalLgs.every(lg => shownLgs.includes(lg)) ? "ì „ì²´ ì‹œì¦Œ" : "ì¼ë¶€ ëŒ€íšŒ");
            let dHtml = shownLgs.length > 1 ? Object.entries(p.details).sort(([,a],[,b])=>b.m-a.m).map(([lgN, d]) => `<tr style="font-size: 0.75rem; color: #888; background-color: #fafafa;"><td style="border:none;"></td><td style="border:none;"></td><td style="text-align:left; padding-left:20px;">â”” ${lgN}</td><td>${d.m}</td><td>${d.g}</td><td>${d.a}</td><td>${d.g+d.a}</td><td>${d.pk}</td><td>${d.cs}</td><td>${d.yc}</td><td>${d.rc}</td></tr>`).join('') : "";
            return `<tr style="${shownLgs.length > 1 ? 'background-color: #fffde7;' : ''}"><td>${p.season}</td><td><b class="clickable" onclick="showPlayerTotal('${p.name}')">${p.name}</b></td><td style="font-weight:bold; text-align:left;">${sumText}</td><td class="${sortState.column==='match'?'highlight-red':''}">${p.match}</td><td class="${sortState.column==='goal'?'highlight-red':''}">${p.goal}</td><td class="${sortState.column==='assist'?'highlight-red':''}">${p.assist}</td><td class="${sortState.column==='ap'?'highlight-red':''}">${p.goal+p.assist}</td><td class="${sortState.column==='pk'?'highlight-red':''}">${p.pk}</td><td class="${sortState.column==='cs'?'highlight-red':''}">${p.cs}</td><td class="${sortState.column==='yc'?'highlight-red':''}">${p.yc}</td><td class="${sortState.column==='rc'?'highlight-red':''}">${p.rc}</td></tr>` + dHtml;
        }).join('');
    }

    function showPlayerTotal(name) {
        const pData = playerSeasonData.filter(p => p.name === name);
        const tot = { m:0, g:0, a:0, pk:0, cs:0, con:0, yc:0, rc:0, seasons:[] };
        pData.forEach(d => { tot.m += parseInt(d.match)||0; tot.g += parseInt(d.goal)||0; tot.a += parseInt(d.assist)||0; tot.pk += parseInt(d.pk)||0; tot.cs += parseInt(d.cleansheet)||0; tot.con += parseInt(d.conceded)||0; tot.yc += parseInt(d.yc)||0; tot.rc += parseInt(d.rc)||0; if(!tot.seasons.includes(d.season)) tot.seasons.push(d.season); });
        const isGK = tot.con > 0 || tot.cs > 0;
        document.getElementById('modal-data').innerHTML = `
            <div class="modal-header"><h2>${name} ì„ ìˆ˜ í†µì‚° ê¸°ë¡</h2></div>
            <div class="modal-grid">
                <div class="stat-card modal-item-full"><div class="stat-label">ì†Œì† ì‹œì¦Œ</div><div class="stat-value">${formatSeasons(tot.seasons)}</div></div>
                <div class="stat-card"><div class="stat-label">í†µì‚° ì¶œì „</div><div class="stat-value">${tot.m}ê²½ê¸°</div></div>
                <div class="stat-card"><div class="stat-label">í†µì‚° ë“ì </div><div class="stat-value">${tot.g}ê³¨</div></div>
                <div class="stat-card"><div class="stat-label">í†µì‚° ë„ì›€</div><div class="stat-value">${tot.a}ë„ì›€</div></div>
                <div class="stat-card"><div class="stat-label">ê³µê²©í¬ì¸íŠ¸</div><div class="stat-value">${tot.g+tot.a}pt</div></div>
                <div class="stat-card"><div class="stat-label">PK ì„±ê³µ</div><div class="stat-value">${tot.pk}</div></div>
                <div class="stat-card"><div class="stat-label">ê²½ê³ /í‡´ì¥</div><div class="stat-value">${tot.yc}/${tot.rc}</div></div>
                ${isGK ? `<div class="stat-card"><div class="stat-label">í´ë¦°ì‹œíŠ¸</div><div class="stat-value">${tot.cs}íšŒ</div></div><div class="stat-card"><div class="stat-label">í†µì‚° ì‹¤ì </div><div class="stat-value">${tot.con}ì‹¤ì </div><div class="rate-small">(ê²½ê¸°ë‹¹ ${(tot.con/tot.m).toFixed(2)})</div></div>` : ''}
            </div>`;
        document.getElementById('modal-overlay').style.display = 'flex';
    }

    function formatSeasons(years) {
        if (!years || years.length === 0) return "";
        const nums = years.map(Number).sort((a, b) => a - b);
        let res = []; let start = nums[0], end = nums[0];
        for (let i = 1; i <= nums.length; i++) { if (i < nums.length && nums[i] === end + 1) end = nums[i]; else { if (start === end) res.push(String(start)); else res.push(`${start}~${String(end).slice(-2)}`); if (i < nums.length) { start = nums[i]; end = nums[i]; } } }
        return res.join(', ');
    }

    function switchMode(m) { currentMode = m; resetToAll(); document.getElementById('team-section').style.display = m === 'team' ? 'block' : 'none'; document.getElementById('player-section').style.display = m === 'player' ? 'block' : 'none'; document.getElementById('mode-t').className = (m === 'team' ? 'mode-btn active' : 'mode-btn'); document.getElementById('mode-p').className = (m === 'player' ? 'mode-btn active' : 'mode-btn'); updateView(); }
    function showHistorySection() { resetToAll(); currentFilter.type = 'opening_match'; document.getElementById('team-section').style.display = 'block'; document.getElementById('player-section').style.display = 'none'; document.getElementById('mode-h').className = 'mode-btn history-btn active'; updateView(); }
    function showAwayFanSection() { resetToAll(); currentFilter.type = 'away_fan'; document.getElementById('team-filter-1').style.display = 'none'; document.getElementById('team-filter-2').style.display = 'none'; document.getElementById('team-notice').style.display = 'none'; const btn = document.getElementById('btn-away-fan'); if(btn) btn.className = 'away-btn active'; sortState = { column: 'awayfan', direction: 'desc' }; updateView(); }
    function showStreakDetail(type) { resetToAll(); currentFilter.type = 'streak_multi'; currentFilter.streakPools = (type === 'win') ? bestWinStreakGroups : bestUnbeatenStreakGroups; document.getElementById('team-filter-1').style.display = 'none'; document.getElementById('team-filter-2').style.display = 'none'; document.getElementById('team-notice').style.display = 'none'; updateView(); }
    function toggleSubLeagues() { const subs = document.querySelectorAll('input[name="p-league"]'); document.getElementById('check-all').checked = Array.from(subs).every(cb => cb.checked); updateView(); }
    function toggleAllLeagues(el) { document.querySelectorAll('input[name="p-league"]').forEach(cb => cb.checked = el.checked); updateView(); }
    function toggleSortOnlyDesc(col) { sortState.column = col; sortState.direction = 'desc'; updateView(); }
    function calculateTotalRankings() { const t = {}; playerSeasonData.forEach(d => { if(!t[d.name]) t[d.name] = { name:d.name, match:0, goal:0, assist:0, cs:0 }; t[d.name].match += parseInt(d.match)||0; t[d.name].goal += parseInt(d.goal)||0; t[d.name].assist += parseInt(d.assist)||0; t[d.name].cs += parseInt(d.cleansheet)||0; }); const r = (id, k) => { const s = Object.values(t).sort((a,b) => b[k] - a[k]).slice(0, 7); const el = document.getElementById(id); if(el) el.innerHTML = s.map((p,i) => `<div class="rank-item"><span>${i+1}. ${p.name}</span><b>${p[k]}</b></div>`).join(''); }; r('rank-match', 'match'); r('rank-goal', 'goal'); r('rank-ap', 'goal'); r('rank-cs', 'cs'); }
    function initFilters() { const tY = [...new Set(rawData.map(m => (m.date || "").substring(0,4)))].sort(); const yS = document.getElementById('select-year'); if(yS) tY.forEach(y => yS.add(new Option(y + " ì‹œì¦Œ", y))); const mgrs = [...new Set(rawData.map(m => m.bfcmanager || m.bfc_manager))].filter(Boolean).sort(); const mS = document.getElementById('select-manager'); if(mS) mgrs.forEach(m => mS.add(new Option(m, m))); const pyS = document.getElementById('p-select-year'); if(pyS) [...new Set(playerSeasonData.map(p => p.season))].sort().forEach(y => pyS.add(new Option(y + " ì‹œì¦Œ", y))); }
    function showSuggestions(input, type) { const v = input.value.trim(); const rL = input.nextElementSibling; if (!v) { rL.style.display = 'none'; return; } let suggestions = (type === 'opponentName') ? [...new Set(rawData.map(m => (m.hometeam||"").includes("ë¶€ì²œ") ? m.awayteam : m.hometeam))].filter(item => item && !item.includes("ë¶€ì²œ") && item.includes(v)) : [...new Set(playerSeasonData.map(p => p.name))].filter(name => name.includes(v)); rL.innerHTML = suggestions.slice(0, 10).map(item => `<li onclick="selectSuggestion('${input.id}', '${item}', '${type}')">${item}</li>`).join(''); rL.style.display = suggestions.length ? 'block' : 'none'; }
    function selectSuggestion(inputId, value, type) { document.getElementById(inputId).value = value; document.getElementById(inputId).nextElementSibling.style.display = 'none'; if(type==='playerName') selectedPlayerSearchName = value; else currentFilter.opponent = value; updateView(); }
    function toggleSort(col) { sortState.direction = (col === sortState.column && sortState.direction === 'desc') ? 'asc' : 'desc'; sortState.column = col; updateView(); }
    function filterByOpponent(name) { if(name.includes("ë¶€ì²œ")) return; currentFilter.opponent = name; updateView(); }
    function resetToAll() { currentFilter = { opponent: null, stadium: null, type: null, streakPools: [] }; sortState = { column: 'date', direction: 'desc' }; selectedPlayerSearchName = ""; isTotalRankMode = false; ['search-opponent','search-opp-manager','search-referee','p-search-name'].forEach(id => {const el=document.getElementById(id); if(el) el.value = "";}); document.getElementById('team-filter-1').style.display = 'grid'; document.getElementById('team-filter-2').style.display = 'grid'; document.getElementById('team-notice').style.display = 'block'; document.getElementById('dynamic-header').style.display='none'; document.getElementById('team-section').style.display = currentMode === 'team' ? 'block' : 'none'; document.getElementById('player-section').style.display = currentMode === 'player' ? 'block' : 'none'; updateView(); }
    function showAllRankings(col) { isTotalRankMode = true; sortState = { column: col, direction: 'desc' }; const h = document.getElementById('dynamic-header'), panel = document.getElementById('player-ranking-panel'), summary = document.getElementById('dynamic-summary'); if (h) { h.style.display = "flex"; document.getElementById('dynamic-title').innerText = `ğŸ† í†µì‚°ê¸°ë¡ ë­í‚¹ ì¡°íšŒ`; if(summary) summary.style.display = "none"; if(panel) panel.style.display = "none"; } renderAllRankingsTable(); }
    function renderAllRankingsTable() { document.getElementById('table-head').innerHTML = `<tr><th>ìˆœìœ„</th><th>ì´ë¦„</th><th onclick="toggleSortTotal('match')">í†µì‚°ì¶œì „ â†•</th><th onclick="toggleSortTotal('goal')">í†µì‚°ë“ì  â†•</th><th onclick="toggleSortTotal('assist')">ë„ì›€ â†•</th><th onclick="toggleSortTotal('ap')">í¬ì¸íŠ¸ â†•</th><th onclick="toggleSortTotal('cs')">í´ë¦°ì‹œíŠ¸ â†•</th><th>ì†Œì†ì‹œì¦Œ</th></tr>`; const t = {}; playerSeasonData.forEach(d => { if(!t[d.name]) t[d.name] = { name:d.name, match:0, goal:0, assist:0, ap:0, cs:0, seasons:[] }; t[d.name].match += parseInt(d.match)||0; t[d.name].goal += parseInt(d.goal)||0; t[d.name].assist += parseInt(d.assist)||0; t[d.name].ap = t[d.name].goal + t[d.name].assist; t[d.name].cs += parseInt(d.cleansheet)||0; if(!t[d.name].seasons.includes(d.season)) t[d.name].seasons.push(d.season); }); let sorted = Object.values(t).sort((a,b) => b[sortState.column] - a[sortState.column]); document.getElementById('table-body').innerHTML = sorted.map((p, i) => `<tr><td>${i+1}</td><td><b class="clickable" onclick="showPlayerTotal('${p.name}')">${p.name}</b></td><td class="${sortState.column==='match'?'highlight-red':''}">${p.match}</td><td class="${sortState.column==='goal'?'highlight-red':''}">${p.goal}</td><td class="${sortState.column==='assist'?'highlight-red':''}">${p.assist}</td><td class="${sortState.column==='ap'?'highlight-red':''}">${p.ap}</td><td class="${sortState.column==='cs'?'highlight-red':''}">${p.cs}</td><td style="font-size:0.75rem">${formatSeasons(p.seasons)}</td></tr>`).join(''); }
    function toggleSortTotal(col) { sortState.column = col; renderAllRankingsTable(); }
    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
    function updateSubLeagues() { toggleSubLeagues(); }
    window.onload = loadData;
</script>
</body>
</html>
