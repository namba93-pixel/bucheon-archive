<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¶€ì²œFC1995 ê³µì‹ê²½ê¸° ì•„ì¹´ì´ë¸Œ</title>
    <style>
        :root { --bfc-red: #ed1c24; --bfc-black: #1a1a1a; --bg-gray: #f4f4f4; }
        body { font-family: 'Pretendard', sans-serif; margin: 0; background-color: var(--bg-gray); color: #333; display: flex; flex-direction: column; min-height: 100vh; }
        header { background: linear-gradient(135deg, var(--bfc-black) 60%, var(--bfc-red)); color: white; padding: 40px 20px 60px; text-align: center; border-bottom: 6px solid var(--bfc-red); position: relative; }
        .home-link { text-decoration: none; color: white; display: inline-flex; align-items: center; gap: 10px; cursor: pointer; }
        header h1 { margin: 0; font-size: 1.8rem; font-weight: 900; }
        .stats-dashboard { background: rgba(255, 255, 255, 0.1); margin: 20px auto 0; padding: 12px 25px; border-radius: 50px; display: inline-block; backdrop-filter: blur(5px); border: 1px solid rgba(255, 255, 255, 0.2); font-size: 0.9rem; }
        .stats-dashboard span { margin: 0 8px; font-weight: 600; }
        .mode-switch { display: flex; justify-content: center; gap: 10px; margin-top: -25px; position: relative; z-index: 100; }
        .mode-btn { background: white; border: 2px solid var(--bfc-red); color: var(--bfc-red); padding: 12px 30px; border-radius: 50px; font-weight: 800; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: 2px solid var(--bfc-red); }
        .mode-btn.active { background: var(--bfc-red); color: white; }
        .container { max-width: 1300px; margin: 30px auto 50px; padding: 0 15px; flex: 1; position: relative; z-index: 10; }
        .ranking-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 40px; }
        .ranking-box { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-top: 4px solid var(--bfc-black); position: relative; }
        .ranking-box h3 { margin: 0 0 15px 0; font-size: 0.95rem; color: var(--bfc-red); }
        .rank-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0; font-size: 0.85rem; }
        .more-btn { background: none; border: none; color: #999; font-size: 0.75rem; cursor: pointer; float: right; margin-top: -35px; }
        .filter-container { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
        .filter-item { display: flex; flex-direction: column; gap: 8px; }
        .filter-item label { font-size: 0.85rem; font-weight: bold; color: #666; }
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; padding: 15px; background: #f9f9f9; border-radius: 10px; border: 1px solid #ddd; }
        .checkbox-group label { font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        select, input { padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 1rem; outline: none; }
        .view-header { margin-top: 20px; background: white; padding: 20px; border-radius: 15px; border-left: 6px solid var(--bfc-red); box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: none; flex-direction: column; gap: 10px; }
        .view-summary { font-size: 0.95rem; color: #555; border-top: 1px dashed #eee; padding-top: 10px; }
        .view-summary span { color: var(--bfc-red); font-weight: bold; }
        .results-box { background: white; border-radius: 15px; margin-top: 15px; overflow-x: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 1100px; }
        th { background: #f8f9fa; padding: 15px; font-size: 0.75rem; color: #555; text-align: center; cursor: pointer; }
        td { padding: 12px; text-align: center; border-bottom: 1px solid #f0f0f0; font-size: 0.85rem; }
        .clickable { color: var(--bfc-black); cursor: pointer; text-decoration: underline; text-decoration-color: #ddd; }
        .win { color: var(--bfc-red); font-weight: bold; }
        .highlight-red { color: var(--bfc-red); font-weight: bold; }
        .data-notice { margin-top: 20px; padding: 12px 18px; font-size: 0.85rem; color: #777; line-height: 1.6; border-left: 4px solid var(--bfc-red); background: #fff; border-radius: 0 10px 10px 0; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 500px; border-radius: 20px; padding: 30px; position: relative; }
        footer { background-color: var(--bfc-black); color: #999; text-align: center; padding: 40px 20px; margin-top: auto; }
        @media (max-width: 1000px) { .ranking-container { grid-template-columns: repeat(2, 1fr); } }
    </style>
</head>
<body>

<div id="modal-overlay" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <span style="position:absolute; top:15px; right:20px; font-size:1.5rem; cursor:pointer; color:#999;" onclick="closeModal()">&times;</span>
        <h2 id="modal-player-name" style="border-bottom:3px solid var(--bfc-red); padding-bottom:15px; margin-bottom:20px; text-align:center;"></h2>
        <div id="modal-data" style="display:grid; grid-template-columns:repeat(2,1fr); gap:10px; text-align:center;"></div>
    </div>
</div>

<header>
    <a href="javascript:void(0)" onclick="resetToAll()" class="home-link"><h1>ë¶€ì²œFC1995 ê³µì‹ê²½ê¸° ê¸°ë¡ í¬í„¸</h1></a>
    <div id="today-date" style="margin-top: 10px; font-size: 1rem; opacity: 0.8;"></div>
    <div class="stats-dashboard"> <span>í†µì‚°</span>
        <span id="stat-total">0ê²½ê¸°</span> | <span id="stat-w">0ìŠ¹</span> <span id="stat-d">0ë¬´</span> <span id="stat-l">0íŒ¨</span> | 
        <span id="stat-gf">0ë“ì </span> <span id="stat-ga">0ì‹¤ì </span> | <span>ìŠ¹ë¥ <span id="stat-rate">0%</span></span>
    </div>
</header>

<div class="mode-switch">
    <button id="mode-t" class="mode-btn active" onclick="switchMode('team')">ğŸŸï¸ íŒ€ ê²½ê¸° ê¸°ë¡</button>
    <button id="mode-p" class="mode-btn" onclick="switchMode('player')">ğŸƒâ€â™‚ï¸ ì„ ìˆ˜ ê°œì¸ ê¸°ë¡</button>
</div>

<div class="container">
    <div id="team-section">
        <div class="filter-container">
            <div class="filter-item"><label>ì‹œì¦Œë³„ ì¡°íšŒ</label><select id="select-year" onchange="updateView()"><option value="">ì „ì²´ ì‹œì¦Œ</option></select></div>
            <div class="filter-item"><label>í™ˆ/ì›ì • ê²½ê¸°</label><select id="select-location" onchange="updateView()"><option value="">ì „ì²´</option><option value="home">í™ˆ ê²½ê¸°</option><option value="away">ì›ì • ê²½ê¸°</option></select></div>
            <div class="filter-item"><label>ê°ë…ë³„ ì¡°íšŒ</label><select id="select-manager" onchange="updateView()"><option value="">ëª¨ë“  ê°ë…</option></select></div>
            <div class="filter-item">
                <label>ëŒ€íšŒë³„ ì¡°íšŒ</label>
                <select id="select-league" onchange="updateView()">
                    <option value="">ëª¨ë“  ëŒ€íšŒ</option>
                    <option value="Kë¦¬ê·¸1">Kë¦¬ê·¸1</option>
                    <option value="Kë¦¬ê·¸2">Kë¦¬ê·¸2</option>
                    <option value="K3ë¦¬ê·¸">K3ë¦¬ê·¸</option>
                    <option value="í”Œë ˆì´ì˜¤í”„">í”Œë ˆì´ì˜¤í”„</option>
                    <option value="ì½”ë¦¬ì•„ì»µ">ì½”ë¦¬ì•„ì»µ</option>
                    <option value="ì±Œë¦°ì €ìŠ¤ì»µ">ì±Œë¦°ì €ìŠ¤ì»µ</option>
                </select>
            </div>
        </div>
        <div class="data-notice">ğŸ“Œ <strong>ë°ì´í„° ì•ˆë‚´:</strong> K3ë¦¬ê·¸ ê²°ê³¼ ì¤‘ ê´€ì¤‘ ìˆ˜ê°€ ëˆ„ë½ëœ ê²½ê¸°ì™€ ì½”ë¡œë‚˜19ë¡œ ì¸í•œ ë¬´ê´€ì¤‘ ê²½ê¸°ëŠ” 0ìœ¼ë¡œ í‘œê¸°ë˜ì–´ ìˆìŠµë‹ˆë‹¤. <br> (ê´€ì¤‘ ìˆœ ì •ë ¬ ì‹œ 0ëª… ë°ì´í„°ëŠ” ì œì™¸ë©ë‹ˆë‹¤.)</div>
    </div>

    <div id="player-section" style="display: none;">
        <div class="ranking-container">
            <div class="ranking-box"><h3>ğŸƒâ€â™‚ï¸ í†µì‚° ì¶œì „ TOP 7</h3><button class="more-btn" onclick="showAllRankings('match')">more</button><div id="rank-match"></div></div>
            <div class="ranking-box"><h3>âš½ í†µì‚° ë“ì  TOP 7</h3><button class="more-btn" onclick="showAllRankings('goal')">more</button><div id="rank-goal"></div></div>
            <div class="ranking-box"><h3>ğŸ”¥ í¬ì¸íŠ¸ TOP 7</h3><button class="more-btn" onclick="showAllRankings('ap')">more</button><div id="rank-ap"></div></div>
            <div class="ranking-box"><h3>ğŸ§¤ í´ë¦°ì‹œíŠ¸ TOP 7</h3><button class="more-btn" onclick="showAllRankings('cs')">more</button><div id="rank-cs"></div></div>
        </div>
        <div class="filter-container">
            <div class="filter-item"><label>ì‹œì¦Œ ì„ íƒ</label><select id="p-select-year" onchange="updateView()"><option value="">ì „ì²´ ì‹œì¦Œ</option></select></div>
            <div class="filter-item"><label>ì„ ìˆ˜ëª… ê²€ìƒ‰</label><input type="text" id="p-search-name" placeholder="ì´ë¦„ ì…ë ¥" onkeyup="updateView()"></div>
            <div class="filter-item" style="grid-column: span 2;">
                <label>ëŒ€íšŒ ì„ íƒ</label>
                <div class="checkbox-group">
                    <label><input type="checkbox" id="check-all" checked onclick="toggleAllLeagues(this)"> ì „ì²´ì„ íƒ</label>
                    <label><input type="checkbox" name="p-league" value="Kë¦¬ê·¸1" checked onchange="updateView()"> Kë¦¬ê·¸1</label>
                    <label><input type="checkbox" name="p-league" value="Kë¦¬ê·¸2" checked onchange="updateView()"> Kë¦¬ê·¸2</label>
                    <label><input type="checkbox" name="p-league" value="í”Œë ˆì´ì˜¤í”„" checked onchange="updateView()"> í”Œë ˆì´ì˜¤í”„</label>
                    <label><input type="checkbox" name="p-league" value="ì½”ë¦¬ì•„ì»µ" checked onchange="updateView()"> ì½”ë¦¬ì•„ì»µ</label>
                </div>
            </div>
        </div>
        <div class="data-notice">ğŸ“Œ <strong>ë°ì´í„° ì•ˆë‚´:</strong> ì„ ìˆ˜ ê¸°ë¡ì€ 2013ë…„ í”„ë¡œ ì§„ì¶œ ì´í›„ ê³µì‹ ê²½ê¸° ë°ì´í„°ë§Œì„ ë°”íƒ•ìœ¼ë¡œ ì§‘ê³„ë©ë‹ˆë‹¤.</div>
    </div>

    <div id="dynamic-header" class="view-header">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div id="dynamic-title" style="font-weight:bold; font-size:1.1rem;"></div>
            <button class="mode-btn" style="padding: 5px 15px; font-size: 0.8rem;" onclick="resetToAll()">ì´ì „ ê²°ê³¼ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
        <div id="dynamic-summary" class="view-summary"></div>
    </div>

    <div class="results-box">
        <table>
            <thead id="table-head"></thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>
</div>

<footer><p>Â© 2026 ë‚¨ì„±í˜„. All Rights Reserved.</p></footer>

<script>
    const TEAM_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQTLnO6CTQkcgJTDHr0MNJAA5xUCCWSqWSq-fgvJkEIGRrOBH1D9EXNXJLxIAriWiQ1oMrSKxTq6Y8m/pub?gid=0&single=true&output=csv";
    const PLAYER_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQTLnO6CTQkcgJTDHr0MNJAA5xUCCWSqWSq-fgvJkEIGRrOBH1D9EXNXJLxIAriWiQ1oMrSKxTq6Y8m/pub?gid=1150204300&single=true&output=csv";

    let rawData = [], playerSeasonData = [], currentMode = 'team';
    let sortState = { column: 'date', direction: 'desc' };
    let currentFilter = { opponent: null, stadium: null };
    let isTotalRankMode = false;

    async function loadData() {
        try {
            const [tRes, pRes] = await Promise.all([
                fetch(TEAM_URL + "&cb=" + Date.now()),
                fetch(PLAYER_URL + "&cb=" + Date.now())
            ]);
            rawData = parseCSV(await tRes.text());
            playerSeasonData = parseCSV(await pRes.text());
            
            const now = new Date();
            document.getElementById('today-date').innerText = `${now.getFullYear()}ë…„ ${now.getMonth() + 1}ì›” ${now.getDate()}ì¼ ê¸°ì¤€`;

            fixAllTimeStats();
            calculateTotalRankings();
            initFilters();
            updateView();
        } catch (e) { document.body.innerHTML = "<h2 style='text-align:center; padding:100px;'>ë°ì´í„° ì—°ë™ ì‹¤íŒ¨. ì‹œíŠ¸ì˜ ì›¹ ê²Œì‹œ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.</h2>"; }
    }

    function parseCSV(text) {
        const rows = text.split(/\r?\n/).filter(l => l.trim() !== "");
        if (rows.length < 1) return [];
        const heads = rows[0].split(',').map(h => h.trim().toLowerCase());
        return rows.slice(1).map(line => {
            const vals = []; let start = 0, inQ = false;
            for (let i = 0; i < line.length; i++) {
                if (line[i] === '"') inQ = !inQ;
                if (line[i] === ',' && !inQ) { vals.push(line.substring(start, i)); start = i + 1; }
            }
            vals.push(line.substring(start));
            let o = {};
            heads.forEach((h, i) => o[h] = (vals[i] || "").trim().replace(/^"|"$/g, ""));
            return o;
        });
    }

    function getUnifiedLeagueName(n) { 
        if(!n) return "";
        const league = n.toLowerCase();
        if(league.includes("í”Œë ˆì´ì˜¤í”„") || league.includes("ìŠ¹ê°•") || league.includes("ì¤€í”Œë ˆì´ì˜¤í”„")) return "í”Œë ˆì´ì˜¤í”„";
        if(league.includes("kë¦¬ê·¸1") || league.includes("k-ë¦¬ê·¸1")) return "Kë¦¬ê·¸1"; 
        if(league.includes("kë¦¬ê·¸2") || league.includes("ì±Œë¦°ì§€")) return "Kë¦¬ê·¸2"; 
        if(league.includes("k3ë¦¬ê·¸") || league.includes("ì±Œë¦°ì €ìŠ¤ë¦¬ê·¸")) return "K3ë¦¬ê·¸";
        if(league.includes("ì±Œë¦°ì €ìŠ¤ì»µ")) return "ì±Œë¦°ì €ìŠ¤ì»µ";
        if(league.includes("faì»µ") || league.includes("ì½”ë¦¬ì•„ì»µ")) return "ì½”ë¦¬ì•„ì»µ";
        return n; 
    }

    function getParticle(name) {
        const charCode = name.charCodeAt(name.length - 1);
        const hasBatchim = (charCode - 0xAC00) % 28 > 0;
        return hasBatchim ? "ê³¼ì˜" : "ì™€ì˜";
    }

    function formatSeasons(years) {
        if (!years.length) return "";
        years.sort((a, b) => a - b);
        let res = []; let start = years[0], end = years[0];
        for (let i = 1; i <= years.length; i++) {
            if (i < years.length && parseInt(years[i]) === parseInt(end) + 1) end = years[i];
            else { res.push(start === end ? start : `${start}~${String(end).slice(-2)}`); if (i < years.length) { start = years[i]; end = years[i]; } }
        }
        return res.join(', ');
    }

    function fixAllTimeStats() {
        let w=0, d=0, l=0, gf=0, ga=0;
        rawData.forEach(m => {
            const isH = (m.hometeam || "").includes("ë¶€ì²œ");
            const myS = isH ? parseInt(m.homescored)||0 : parseInt(m.awayscored)||0;
            const opS = isH ? parseInt(m.awayscored)||0 : parseInt(m.homescored)||0;
            gf += myS; ga += opS;
            if (myS > opS) w++; else if (myS < opS) l++; else d++;
        });
        const total = rawData.length;
        document.getElementById('stat-total').innerText = total + "ê²½ê¸°";
        document.getElementById('stat-w').innerText = w + "ìŠ¹"; document.getElementById('stat-d').innerText = d + "ë¬´"; document.getElementById('stat-l').innerText = l + "íŒ¨";
        document.getElementById('stat-gf').innerText = gf + "ë“"; document.getElementById('stat-ga').innerText = ga + "ì‹¤";
        document.getElementById('stat-rate').innerText = total ? (((w + d * 0.5) / total) * 100).toFixed(1) + "%" : "0%";
    }

    function switchMode(m) {
    currentMode = m; 
    isTotalRankMode = false;
    
    // [ë³´ì •] ëª¨ë“œ ì „í™˜ ì‹œ íŒ€ ê¸°ë¡ì˜ ì „ì  ì¡°íšŒ í•„í„°ì™€ í—¤ë”ë¥¼ ì´ˆê¸°í™”
    currentFilter = { opponent: null, stadium: null };
    if (document.getElementById('dynamic-header')) {
        document.getElementById('dynamic-header').style.display = 'none';
    }
    
    document.getElementById('team-section').style.display = m === 'team' ? 'block' : 'none';
    document.getElementById('player-section').style.display = m === 'player' ? 'block' : 'none';
    document.getElementById('mode-t').className = (m === 'team' ? 'mode-btn active' : 'mode-btn');
    document.getElementById('mode-p').className = (m === 'player' ? 'mode-btn active' : 'mode-btn');
    
    // ì„ ìˆ˜ ê¸°ë¡ ëª¨ë“œë¡œ ê°ˆ ë•Œ ë­í‚¹ ê°±ì‹ 
    if(m === 'player') { 
        sortState = { column: 'match', direction: 'desc' }; 
        calculateTotalRankings(); 
    } else {
        sortState = { column: 'date', direction: 'desc' };
    }
    
    updateView();
}

    function updateView() {
        if (currentMode === 'team') renderTeamTable();
        else { if (isTotalRankMode) renderAllRankingsTable(); else renderPlayerTable(); }
    }

    function renderTeamTable() {
        const year = document.getElementById('select-year').value;
        const loc = document.getElementById('select-location').value;
        const mgr = document.getElementById('select-manager').value;
        const selLg = document.getElementById('select-league').value;

        const header = document.getElementById('dynamic-header');
        const summary = document.getElementById('dynamic-summary');

        if (currentFilter.opponent || currentFilter.stadium || year || mgr || selLg) {
            header.style.display = "flex";
            let titleParts = [];
            if (currentFilter.stadium) titleParts.push(`${currentFilter.stadium}ì—ì„œ`);
            if (currentFilter.opponent) titleParts.push(`${currentFilter.opponent}${getParticle(currentFilter.opponent)}`);
            if (mgr) titleParts.push(`${mgr} ê°ë…ì˜`);
            if (selLg) titleParts.push(`${selLg}`);
            const seasonText = year ? `${year}ì‹œì¦Œ` : "í†µì‚°";
            document.getElementById('dynamic-title').innerText = `ğŸ” ${titleParts.join(" ")} ${seasonText} ê²½ê¸°ê²°ê³¼`;
        } else { header.style.display = "none"; }

        let filtered = rawData.filter(m => {
            const isH = (m.hometeam || "").includes("ë¶€ì²œ");
            const opp = isH ? m.awayteam : m.hometeam;
            if (currentFilter.opponent && opp !== currentFilter.opponent) return false;
            if (currentFilter.stadium && m.stadium !== currentFilter.stadium) return false;
            if (year && !m.date.startsWith(year)) return false;
            if (mgr && m.bfcmanager !== mgr && m.bfc_manager !== mgr) return false;
            if (loc && (loc === 'home' ? !isH : isH)) return false;
            if (selLg && getUnifiedLeagueName(m.league) !== selLg) return false;
            return true;
        });

        let tw=0, td=0, tl=0, tgf=0, tga=0;
        filtered.forEach(m => {
            const isH = (m.hometeam || "").includes("ë¶€ì²œ");
            const hS = parseInt(m.homescored)||0, aS = parseInt(m.awayscored)||0;
            const myS = isH ? hS : aS, opS = isH ? aS : hS;
            tgf += myS; tga += opS;
            if (myS > opS) tw++; else if (myS < opS) tl++; else td++;
        });
        const tRate = filtered.length ? (((tw + td * 0.5) / filtered.length) * 100).toFixed(1) : 0;
        if(header.style.display !== "none") {
            summary.innerHTML = `ì¡°íšŒ ê²°ê³¼: <span>${filtered.length}ê²½ê¸° ${tw}ìŠ¹ ${td}ë¬´ ${tl}íŒ¨</span> (${tgf}ë“ì  ${tga}ì‹¤ì  / ìŠ¹ë¥  <span>${tRate}%</span>)`;
        }

        let displayData = [...filtered];
        if (sortState.column === 'attendance') {
            displayData = displayData.filter(m => (parseInt(String(m.attendance).replace(/,/g,''))||0) > 0);
        }
        displayData.sort((a,b) => {
            let vA = a[sortState.column], vB = b[sortState.column];
            if(sortState.column === 'attendance') { vA = parseInt(String(vA).replace(/,/g,''))||0; vB = parseInt(String(vB).replace(/,/g,''))||0; }
            return sortState.direction === 'asc' ? (vA > vB ? 1 : -1) : (vA < vB ? 1 : -1);
        });

        document.getElementById('table-head').innerHTML = `<tr><th onclick="toggleSort('date')">ë‚ ì§œ â†•</th><th>ëŒ€íšŒ</th><th>ìƒëŒ€</th><th>ì¥ì†Œ</th><th>ìŠ¤ì½”ì–´</th><th>ê²°ê³¼</th><th onclick="toggleSort('attendance')">ê´€ì¤‘ â†•</th><th>ê°ë…</th></tr>`;
        document.getElementById('table-body').innerHTML = displayData.map(m => {
            const isH = (m.hometeam || "").includes("ë¶€ì²œ");
            const hS = parseInt(m.homescored)||0, aS = parseInt(m.awayscored)||0;
            let res = (isH ? hS : aS) > (isH ? aS : hS) ? "ìŠ¹" : ((isH ? hS : aS) < (isH ? aS : hS) ? "íŒ¨" : "ë¬´");
            const oppName = isH ? m.awayteam : m.hometeam;
            const attn = parseInt(String(m.attendance).replace(/,/g,''))||0;
            return `<tr><td>${m.date}</td><td>${m.league}</td><td><b class="clickable" onclick="filterByOpponent('${oppName}')">${oppName}</b></td><td><span class="clickable" onclick="filterByStadium('${m.stadium}')">${m.stadium}</span></td><td>${hS}:${aS}</td><td class="${res==='ìŠ¹'?'win':''}">${res}</td><td>${attn > 0 ? attn.toLocaleString() : "-"}</td><td>${m.bfcmanager || m.bfc_manager || "-"}</td></tr>`;
        }).join('');
    }

    function renderPlayerTable() {
    const year = document.getElementById('p-select-year').value;
    const nameSearch = document.getElementById('p-search-name').value;
    const selectedLeagues = Array.from(document.querySelectorAll('input[name="p-league"]:checked')).map(cb => cb.value);
    
    // í—¤ë” ë³µêµ¬
    document.getElementById('table-head').innerHTML = `<tr><th onclick="toggleSort('season')">ì‹œì¦Œ â†•</th><th>ì´ë¦„</th><th>ëŒ€íšŒ</th><th onclick="toggleSort('match')">ê²½ê¸° â†•</th><th onclick="toggleSort('goal')">ë“ì  â†•</th><th onclick="toggleSort('assist')">ë„ì›€ â†•</th><th onclick="toggleSort('ap')">í¬ì¸íŠ¸ â†•</th><th>PK</th><th>CS</th><th>ê²½ê³ </th></tr>`;

    // 1. ë°ì´í„° í•„í„°ë§
    let filtered = playerSeasonData.filter(p => {
        if(year && p.season !== year) return false;
        if(nameSearch && !p.name.includes(nameSearch)) return false;
        if(!selectedLeagues.includes(getUnifiedLeagueName(p.league))) return false;
        return true;
    });

    // 2. ì„ ìˆ˜ë³„/ì‹œì¦Œë³„ ê·¸ë£¹í™” (í•©ì‚° ë¡œì§)
    const grouped = {};
    filtered.forEach(p => {
        const key = `${p.name}_${p.season}`;
        if (!grouped[key]) {
            grouped[key] = {
                name: p.name, season: p.season,
                match: 0, goal: 0, assist: 0, pk: 0, cs: 0, yc: 0,
                details: {} // ëŒ€íšŒë³„ë¡œ ë‹¤ì‹œ ë¬¶ìŒ
            };
        }
        const uniLg = getUnifiedLeagueName(p.league);
        if (!grouped[key].details[uniLg]) {
            grouped[key].details[uniLg] = { m: 0, g: 0, a: 0, pk: 0, cs: 0, yc: 0 };
        }

        // ì „ì²´ í•©ì‚°
        grouped[key].match += parseInt(p.match) || 0;
        grouped[key].goal += parseInt(p.goal) || 0;
        grouped[key].assist += parseInt(p.assist) || 0;
        grouped[key].pk += parseInt(p.pk) || 0;
        grouped[key].cs += parseInt(p.cleansheet) || 0;
        grouped[key].yc += parseInt(p.yc) || 0;

        // ëŒ€íšŒë³„ í•©ì‚°
        grouped[key].details[uniLg].m += parseInt(p.match) || 0;
        grouped[key].details[uniLg].g += parseInt(p.goal) || 0;
        grouped[key].details[uniLg].a += parseInt(p.assist) || 0;
        grouped[key].details[uniLg].pk += parseInt(p.pk) || 0;
        grouped[key].details[uniLg].cs += parseInt(p.cleansheet) || 0;
        grouped[key].details[uniLg].yc += parseInt(p.yc) || 0;
    });

    let displayData = Object.values(grouped);

    // 3. ì •ë ¬ ë¡œì§ (ë©”ì¸ í•©ì‚°ì¹˜ ê¸°ì¤€)
    displayData.sort((a, b) => {
        let vA, vB;
        if (sortState.column === 'ap') {
            vA = a.goal + a.assist; vB = b.goal + b.assist;
        } else {
            vA = a[sortState.column]; vB = b[sortState.column];
        }
        return sortState.direction === 'asc' ? vA - vB : vB - vA;
    });

    // 4. í…Œì´ë¸” ë Œë”ë§
    document.getElementById('table-body').innerHTML = displayData.map(p => {
        const totalAp = p.goal + p.assist;
        const hasMultiple = Object.keys(p.details).length > 1;
        
    // ëŒ€íšŒë³„ ì„¸ë¶€ í–‰ ìƒì„± ë¡œì§
    let detailsHtml = "";
    if (hasMultiple) {
        // [ìˆ˜ì •] ì¶œì „ ê²½ê¸° ìˆ˜(m)ê°€ ë§ì€ ìˆœì„œëŒ€ë¡œ ì •ë ¬í•˜ì—¬ ë…¸ì¶œí•©ë‹ˆë‹¤.
        const sortedDetails = Object.entries(p.details).sort(([, a], [, b]) => b.m - a.m);
        
        detailsHtml = sortedDetails.map(([lgName, d]) => {
            const dAp = d.g + d.a;
            return `
                <tr style="font-size: 0.75rem; color: #888; background-color: #fafafa;">
                    <td style="border:none;"></td><td style="border:none;"></td>
                    <td style="text-align:left; padding-left:20px;">â”” ${lgName}</td>
                    <td>${d.m}</td><td>${d.g}</td><td>${d.a}</td><td>${dAp}</td>
                    <td>${d.pk}</td><td>${d.cs}</td><td>${d.yc}</td>
                </tr>`;
            }).join('');
        }

        // ë©”ì¸ í•©ì‚° í–‰
        const mainRow = `
            <tr style="${hasMultiple ? 'background-color: #fffde7;' : ''}">
                <td>${p.season}</td>
                <td><b class="clickable" onclick="showPlayerTotal('${p.name}')">${p.name}</b></td>
                <td style="font-weight:bold; text-align:left;">${hasMultiple ? 'ì „ì²´ ì‹œì¦Œ' : Object.keys(p.details)[0]}</td>
                <td style="font-weight:bold;">${p.match}</td>
                <td style="font-weight:bold;">${p.goal}</td>
                <td style="font-weight:bold;">${p.assist}</td>
                <td class="${sortState.column==='ap'?'highlight-red':''}" style="font-weight:bold;">${totalAp}</td>
                <td>${p.pk}</td><td>${p.cs}</td><td>${p.yc}</td>
            </tr>`;

        return mainRow + detailsHtml;
    }).join('');
}

    function renderAllRankingsTable() {
        document.getElementById('table-head').innerHTML = `<tr><th>ìˆœìœ„</th><th>ì´ë¦„</th><th onclick="toggleSortTotal('match')">í†µì‚°ì¶œì „ â†•</th><th onclick="toggleSortTotal('goal')">í†µì‚°ë“ì  â†•</th><th onclick="toggleSortTotal('assist')">ë„ì›€ â†•</th><th onclick="toggleSortTotal('ap')">í¬ì¸íŠ¸ â†•</th><th onclick="toggleSortTotal('cs')">CS â†•</th><th>ì†Œì†ì‹œì¦Œ</th></tr>`;
        const t = {};
        playerSeasonData.forEach(d => {
            if(!t[d.name]) t[d.name] = { name:d.name, match:0, goal:0, assist:0, ap:0, cs:0, seasons:[] };
            t[d.name].match += parseInt(d.match)||0; 
            t[d.name].goal += parseInt(d.goal)||0;
            t[d.name].assist += parseInt(d.assist)||0;
            // [ê³„ì‚° ìˆ˜ì •] ê³µê²©í¬ì¸íŠ¸ í•©ì‚° ê´„í˜¸ ë³´ì •
            t[d.name].ap += ((parseInt(d.goal)||0) + (parseInt(d.assist)||0));
            t[d.name].cs += parseInt(d.cleansheet)||0; 
            if(!t[d.name].seasons.includes(d.season)) t[d.name].seasons.push(d.season);
        });
        let sorted = Object.values(t).sort((a,b) => b[sortState.column] - a[sortState.column]);
        document.getElementById('table-body').innerHTML = sorted.map((p, i) => `<tr><td>${i+1}</td><td><b class="clickable" onclick="showPlayerTotal('${p.name}')">${p.name}</b></td><td class="${sortState.column==='match'?'highlight-red':''}">${p.match}</td><td class="${sortState.column==='goal'?'highlight-red':''}">${p.goal}</td><td>${p.assist}</td><td class="${sortState.column==='ap'?'highlight-red':''}">${p.ap}</td><td class="${sortState.column==='cs'?'highlight-red':''}">${p.cs}</td><td style="font-size:0.75rem">${formatSeasons(p.seasons)}</td></tr>`).join('');
    }

    function calculateTotalRankings() {
        const t = {};
        playerSeasonData.forEach(d => {
            if(!t[d.name]) t[d.name] = { name:d.name, match:0, goal:0, assist:0, ap:0, cs:0 };
            t[d.name].match += parseInt(d.match)||0; 
            t[d.name].goal += parseInt(d.goal)||0;
            t[d.name].assist += parseInt(d.assist)||0;
            // [ê³„ì‚° ìˆ˜ì •] TOP 7 ê³µê²©í¬ì¸íŠ¸ í•©ì‚° ë³´ì •
            t[d.name].ap += ((parseInt(d.goal)||0) + (parseInt(d.assist)||0)); 
            t[d.name].cs += parseInt(d.cleansheet)||0;
        });
        const r = (id, k, u) => {
            const s = Object.values(t).sort((a,b) => b[k]-a[k]).slice(0,7);
            document.getElementById(id).innerHTML = s.map((p,i) => `<div class="rank-item"><span>${i+1}. ${p.name}</span><b>${p[k]}${u}</b></div>`).join('');
        };
        r('rank-match', 'match', 'ê²½ê¸°'); r('rank-goal', 'goal', 'ê³¨'); r('rank-ap', 'ap', 'pt'); r('rank-cs', 'cs', 'íšŒ');
    }

    function initFilters() {
        const tY = [...new Set(rawData.map(m => m.date.substring(0,4)))].sort();
        const ySel = document.getElementById('select-year');
        ySel.innerHTML = '<option value="">ì „ì²´ ì‹œì¦Œ</option>';
        tY.forEach(y => ySel.add(new Option(y + " ì‹œì¦Œ", y)));
        const pY = [...new Set(playerSeasonData.map(p => p.season))].sort();
        const pySel = document.getElementById('p-select-year');
        pySel.innerHTML = '<option value="">ì „ì²´ ì‹œì¦Œ</option>';
        pY.forEach(y => pySel.add(new Option(y + " ì‹œì¦Œ", y)));
        const mgrs = [...new Set(rawData.map(m => m.bfcmanager || m.bfc_manager))].filter(Boolean).sort();
        const mSel = document.getElementById('select-manager');
        mSel.innerHTML = '<option value="">ëª¨ë“  ê°ë…</option>';
        mgrs.forEach(m => mSel.add(new Option(m, m)));
    }

    function toggleSort(col) { sortState.column = col; sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc'; updateView(); }
    function toggleSortTotal(col) { sortState.column = col; sortState.direction = 'desc'; updateView(); }
    function toggleAllLeagues(el) { document.querySelectorAll('input[name="p-league"]').forEach(cb => cb.checked = el.checked); updateView(); }
    function filterByOpponent(name) { currentFilter.opponent = name; updateView(); }
    function filterByStadium(name) { currentFilter.stadium = name; updateView(); }
    function showAllRankings(col) { isTotalRankMode = true; sortState = { column: col, direction: 'desc' }; updateView(); }
    function resetToAll() { currentFilter = { opponent: null, stadium: null }; isTotalRankMode = false; updateView(); }
    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
    
    function showPlayerTotal(name) {
        const pData = playerSeasonData.filter(p => p.name === name);
        const tot = { m:0, g:0, a:0, pk:0, cs:0, con:0, yc:0, rc:0 };
        pData.forEach(d => { tot.m += parseInt(d.match)||0; tot.g += parseInt(d.goal)||0; tot.a += parseInt(d.assist)||0; tot.pk += parseInt(d.pk)||0; tot.cs += parseInt(d.cleansheet)||0; tot.con += parseInt(d.conceded)||0; tot.yc += parseInt(d.yc)||0; tot.rc += parseInt(d.rc)||0; });
        const apSum = tot.g + tot.a;
        
        // [ë³´ì •] ì‹¤ì  ê¸°ë¡(tot.con)ì´ 0ë³´ë‹¤ í° ê²½ìš°ì—ë§Œ ê³¨í‚¤í¼ ì§€í‘œë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤.
        let gkStatsHtml = "";
        if (tot.con > 0 || tot.cs > 0) {
            gkStatsHtml = `<div class="modal-item">í´ë¦°ì‹œíŠ¸<br><b>${tot.cs}</b></div>
                           <div class="modal-item-wide"> ì‹¤ì <br><b>${tot.con}ì‹¤ì </b></div>`;
    }

    document.getElementById('modal-player-name').innerText = name + " ë¶€ì²œ í†µì‚° ê¸°ë¡";
    document.getElementById('modal-data').innerHTML = `
        <div class="modal-item">ê²½ê¸°<br><b>${tot.m}</b></div>
        <div class="modal-item">ë“ì <br><b>${tot.g}</b></div>
        <div class="modal-item">ë„ì›€<br><b>${tot.a}</b></div>
        <div class="modal-item">í¬ì¸íŠ¸<br><b>${apSum}</b></div>
        <div class="modal-item-wide">PK ì„±ê³µ: ${tot.pk} | ê²½ê³ /í‡´ì¥: ${tot.yc}/${tot.rc}</div>
        ${gkStatsHtml}
    `;
    document.getElementById('modal-overlay').style.display = 'flex';
}

    window.onload = loadData;
</script>
</body>
</html>









